<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agrocota - Painel de Decisao</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#040404; --surface:#0e0e0e; --surface2:#161616;
      --border:#1e1e1e; --border2:#2a2a2a;
      --primary:#22c55e; --primary-dim:#021a09;
      --text:#f0f0f0; --text-mid:#666; --text-low:#333;
      --red:#ef4444; --amber:#f59e0b;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}

    /* ── STATES ── */
    #state-loading,#state-error{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100svh;gap:16px}
    #state-error{padding:32px;text-align:center}
    .loader{width:32px;height:32px;border:2px solid var(--border2);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .state-label{font-size:.7rem;font-weight:700;letter-spacing:.1em;color:var(--text-mid);text-transform:uppercase}
    .err-title{font-size:.95rem;font-weight:800;color:var(--red)}
    .err-body{font-size:.78rem;color:var(--text-mid);margin-top:6px}

    /* ── TOP BAR ── */
    .top-bar{position:sticky;top:0;z-index:100;background:rgba(4,4,4,.88);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--border);padding:13px 20px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{font-size:.68rem;font-weight:900;letter-spacing:.2em;color:var(--primary);text-transform:uppercase;flex-shrink:0}
    .top-bar-right{display:flex;align-items:center;gap:10px}
    .status-pill{font-size:.58rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase;padding:4px 10px;border-radius:100px;border:1px solid var(--border2);color:var(--text-mid)}
    .status-pill.pendente{border-color:var(--amber);color:var(--amber)}
    .status-pill.aprovado{border-color:var(--primary);color:var(--primary)}
    .status-pill.recusado{border-color:var(--red);color:var(--red)}
    .btn-pdf{font-size:.58rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase;padding:4px 12px;border-radius:100px;background:var(--primary);color:#000;border:none;cursor:pointer;transition:opacity .15s}
    .btn-pdf:hover{opacity:.85}

    /* ── PAGE ── */
    .page{max-width:640px;margin:0 auto;padding:28px 16px 160px}

    /* ── META ── */
    .meta-block{margin-bottom:36px}
    .meta-title{font-size:1.5rem;font-weight:900;line-height:1.2;letter-spacing:-.02em;margin-bottom:18px}
    .meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    @media(max-width:380px){.meta-grid{grid-template-columns:1fr}}
    .meta-cell{background:var(--surface);padding:12px 14px}
    .meta-cell.full{grid-column:1/-1}
    .meta-key{font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-mid);margin-bottom:3px}
    .meta-val{font-size:.88rem;font-weight:600;color:var(--text)}

    /* ── SECTION HEADER ── */
    .section-hd{display:flex;align-items:center;gap:10px;margin-bottom:14px;margin-top:36px}
    .section-hd h2{font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--text-mid);white-space:nowrap}
    .section-line{flex:1;height:1px;background:var(--border)}

    /* ── CHART ── */
    .chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px 20px;display:flex;flex-direction:column;align-items:center;gap:28px}
    .chart-canvas-wrap{position:relative;width:190px;height:190px;flex-shrink:0}
    canvas#donut{width:190px !important;height:190px !important}
    .chart-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
    .chart-center-label{font-size:.55rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-mid)}
    .chart-center-value{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:700;color:var(--text);display:block;line-height:1.3}
    .chart-legend{width:100%;display:flex;flex-direction:column;gap:9px}
    .legend-row{display:flex;align-items:center;gap:10px}
    .legend-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .legend-name{flex:1;font-size:.76rem;font-weight:600;color:var(--text)}
    .legend-bar-wrap{flex:1.5;height:3px;background:var(--border2);border-radius:99px;overflow:hidden}
    .legend-bar{height:100%;border-radius:99px;transition:width .6s cubic-bezier(.4,0,.2,1)}
    .legend-val{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:700;min-width:82px;text-align:right}

    /* ── CATEGORY SECTIONS ── */
    .cat-section{margin-bottom:36px}
    .cat-section-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;margin-top:28px;padding:12px 14px 10px;background:var(--surface2);border:1px solid var(--border2);border-radius:12px;position:relative;overflow:hidden}
    .cat-color-bar{position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
    .cat-section-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .cat-section-title{font-size:.88rem;font-weight:900;color:var(--text);flex:1}
    .cat-section-count{font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-mid)}
    .cat-section-min{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:700;color:var(--primary);white-space:nowrap}

    /* ── PRODUCT GROUPS ── */
    .prod-group{margin-bottom:20px}
    .prod-group-title{font-size:.85rem;font-weight:800;color:var(--text);margin-bottom:5px}
    /* chips de principio_ativo / fonte / empresa no cabeçalho do grupo */
    .prod-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
    .prod-chip{display:flex;align-items:center;gap:4px;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:3px 8px}
    .prod-chip-key{font-size:.55rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text-mid)}
    .prod-chip-val{font-size:.7rem;font-weight:700;color:var(--text)}

    /* ── OPTION CARDS ── */
    .option-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:flex-start;gap:12px}
    .option-card.cheapest{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.03)}
    .option-card.expensive{border-color:rgba(239,68,68,.2)}
    .option-info{flex:1;min-width:0}
    .option-forn{font-size:.83rem;font-weight:700;color:var(--text)}
    /* chips menores dentro do card (dose, etc) */
    .option-sub-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
    .option-sub-chip{font-size:.6rem;font-weight:600;padding:2px 7px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);color:var(--text-mid)}
    .option-sub-chip b{color:var(--text);font-weight:700}
    .option-price-col{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
    .option-price{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:700}
    .badge-menor{font-size:.52rem;font-weight:900;letter-spacing:.08em;text-transform:uppercase;padding:2px 7px;border-radius:5px;background:var(--primary);color:#000}
    .badge-maior{font-size:.52rem;font-weight:900;letter-spacing:.08em;text-transform:uppercase;padding:2px 7px;border-radius:5px;background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.3)}

    /* ── APPROVED BANNER ── */
    .approved-card{background:var(--primary-dim);border:1px solid var(--primary);border-radius:18px;padding:22px;text-align:center;margin-bottom:28px}
    .approved-card.recusado{background:rgba(239,68,68,.08);border-color:var(--red)}
    .approved-card.recusado .approved-title,.approved-card.recusado .approved-ts{color:var(--red)}
    .approved-title{font-size:.95rem;font-weight:900;color:var(--primary);margin-bottom:5px}
    .approved-sub{font-size:.75rem;color:var(--text-mid)}
    .approved-ts{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--primary);margin-top:8px}

    /* ── STICKY FOOTER ── */
    .sticky-footer{position:fixed;bottom:0;left:0;right:0;z-index:200;padding:14px 16px calc(14px + env(safe-area-inset-bottom));background:linear-gradient(to top,var(--bg) 65%,transparent)}
    .footer-inner{max-width:640px;margin:0 auto}
    .total-row{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px;padding:0 2px}
    .total-label-sm{font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-mid)}
    .total-amount{font-family:'JetBrains Mono',monospace;font-size:1.15rem;font-weight:700;color:var(--text)}
    .total-sub{font-size:.58rem;color:var(--text-mid);text-align:right;display:block}
    .footer-actions{display:grid;grid-template-columns:1fr 2fr;gap:10px}
    .btn-confirm{width:100%;background:var(--primary);color:#000;border:none;padding:16px 24px;border-radius:15px;font-family:'Inter',sans-serif;font-size:.75rem;font-weight:900;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:opacity .18s,transform .12s;box-shadow:0 0 40px rgba(34,197,94,.12)}
    .btn-confirm:active{transform:scale(.97)}
    .btn-confirm:disabled{opacity:.3;cursor:not-allowed;box-shadow:none}
    .btn-reject{width:100%;background:transparent;color:#fca5a5;border:1px solid rgba(239,68,68,.45);padding:16px 14px;border-radius:15px;font-family:'Inter',sans-serif;font-size:.72rem;font-weight:900;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:opacity .18s,transform .12s}
    .btn-reject:active{transform:scale(.97)}
    .btn-reject:disabled{opacity:.35;cursor:not-allowed}

    /* ── MODAL ── */
    .modal-backdrop{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.8);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:flex-end;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .25s}
    .modal-backdrop.open{opacity:1;pointer-events:all}
    .modal{background:var(--surface2);border:1px solid var(--border2);border-radius:24px;padding:26px 22px;width:100%;max-width:620px;transform:translateY(24px);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:88svh;display:flex;flex-direction:column}
    .modal-backdrop.open .modal{transform:translateY(0)}
    .modal-title{font-size:.95rem;font-weight:900;margin-bottom:5px;flex-shrink:0}
    .modal-sub{font-size:.75rem;color:var(--text-mid);margin-bottom:16px;flex-shrink:0}
    .modal-scroll{overflow-y:auto;flex:1}
    /* item no modal — com chips de detalhes */
    .modal-item{padding:11px 0;border-bottom:1px solid var(--border)}
    .modal-item:last-child{border-bottom:none}
    .modal-item-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:5px}
    .modal-item-name{font-size:.8rem;font-weight:700;color:var(--text);flex:1}
    .modal-item-price{font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:700;color:var(--primary);flex-shrink:0}
    .modal-item-chips{display:flex;flex-wrap:wrap;gap:5px}
    .modal-chip{font-size:.6rem;font-weight:600;padding:2px 7px;border-radius:5px;background:var(--surface);border:1px solid var(--border);color:var(--text-mid)}
    .modal-chip b{color:var(--text);font-weight:700}
    .modal-total{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:14px;border-top:1px solid var(--border2);flex-shrink:0}
    .modal-total-label{font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-mid)}
    .modal-total-val{font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:900;color:var(--text)}
    .modal-actions{display:flex;gap:10px;margin-top:16px;flex-shrink:0}
    .btn-cancel{flex:1;background:transparent;border:1px solid var(--border2);color:var(--text-mid);padding:14px;border-radius:12px;font-family:'Inter',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:background .18s}
    .btn-cancel:hover{background:var(--border)}
    .btn-confirm-modal{flex:2;background:var(--primary);color:#000;border:none;padding:14px;border-radius:12px;font-family:'Inter',sans-serif;font-size:.72rem;font-weight:900;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:opacity .18s}
    .btn-confirm-modal:disabled{opacity:.5;cursor:not-allowed}

    .page-footer{text-align:center;padding:12px 16px;font-size:.6rem;color:var(--text-low);letter-spacing:.06em;text-transform:uppercase}

    /* ── PRINT / PDF ── */
    @media print {
      body{background:#fff !important;color:#111 !important}
      .top-bar,.sticky-footer,.modal-backdrop,.btn-pdf{display:none !important}
      .page{padding:0 !important;max-width:100% !important}
      .chart-wrap,.meta-cell,.cat-section-header,.option-card,.prod-chip,.option-sub-chip{background:#f8f8f8 !important;border-color:#ddd !important;color:#111 !important}
      .approved-card{background:#e8f5e9 !important;border-color:#4caf50 !important}
      canvas{max-width:160px !important}
      .cat-section,.option-card,.prod-group{break-inside:avoid}
    }
  </style>
</head>
<body>

<div id="state-loading">
  <div class="loader"></div>
  <span class="state-label">Carregando cotação</span>
</div>
<div id="state-error" style="display:none">
  <span class="err-title" id="err-title">Link inválido ou expirado</span>
  <p class="err-body">Solicite um novo link ao consultor responsável.</p>
</div>

<div id="app" style="display:none">
  <div class="top-bar">
    <span class="brand">Agrocota</span>
    <div class="top-bar-right">
      <button class="btn-pdf" onclick="window.print()">Baixar PDF</button>
      <span class="status-pill pendente" id="status-pill">Aguardando aceite</span>
    </div>
  </div>

  <main class="page">
    <div class="meta-block">
      <h1 class="meta-title" id="meta-titulo">Cotação</h1>
      <div class="meta-grid" id="meta-grid"></div>
    </div>

    <div class="approved-card" id="approved-banner" style="display:none">
      <div class="approved-title">Aceite Registrado</div>
      <div class="approved-sub">Seu consultor foi notificado. Obrigado pela confirmação.</div>
      <div class="approved-ts" id="approved-ts"></div>
    </div>

    <div class="section-hd">
      <h2>Composição de custo</h2>
      <div class="section-line"></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-canvas-wrap">
        <canvas id="donut"></canvas>
        <div class="chart-center">
          <span class="chart-center-label">Investimento</span>
          <span class="chart-center-value" id="center-total">R$ 0,00</span>
        </div>
      </div>
      <div class="chart-legend" id="chart-legend"></div>
    </div>

    <div class="section-hd" style="margin-top:44px">
      <h2>Produtos por categoria</h2>
      <div class="section-line"></div>
    </div>
    <div id="prod-list"></div>
  </main>

  <div class="sticky-footer" id="sticky-footer">
    <div class="footer-inner">
      <div class="total-row">
        <div>
          <div class="total-label-sm">Investimento Total</div>
          <span class="total-sub" id="footer-count">0 itens</span>
        </div>
        <div style="text-align:right">
          <div class="total-amount" id="footer-total">R$ 0,00</div>
        </div>
      </div>
      <div class="footer-actions">
        <button class="btn-reject" id="btn-recusar" onclick="abrirModalRecusa()">Recusar</button>
        <button class="btn-confirm" id="btn-aceite" onclick="abrirModal()" disabled>Confirmar Aceite</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-recusar-backdrop" onclick="fecharModalRecusaExterno(event)">
  <div class="modal" style="max-height:unset">
    <div class="modal-title">Confirmar Recusa</div>
    <div class="modal-sub">Ao recusar, o consultor será notificado e esta cotação ficará como recusada.</div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModalRecusa()">Voltar</button>
      <button class="btn-confirm-modal" id="btn-recusar-modal" onclick="confirmarRecusa()" style="background:#ef4444;color:#fff">Confirmar Recusa</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-backdrop" onclick="fecharModalExterno(event)">
  <div class="modal">
    <div class="modal-title">Confirmar Aceite</div>
    <div class="modal-sub">Revise os produtos antes de confirmar. Esta ação será registrada com data, hora e dispositivo.</div>
    <div class="modal-scroll" id="modal-summary"></div>
    <div class="modal-total">
      <span class="modal-total-label">Investimento Total</span>
      <span class="modal-total-val" id="modal-total-val">R$ 0,00</span>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModal()">Voltar</button>
      <button class="btn-confirm-modal" id="btn-confirm-modal" onclick="confirmarAceite()">Confirmar Aceite</button>
    </div>
  </div>
</div>

<footer class="page-footer">Agrocota 2025 &mdash; Plataforma de Decisao Agricola</footer>

<script>
  const SUPABASE_URL  = 'https://fafjknchnibdflpqyssf.supabase.co';
  const SUPABASE_ANON = 'sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r';

  const PALETTE = ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6','#06B6D4','#EC4899','#84CC16','#F97316','#14B8A6','#6366F1','#EAB308','#22C55E','#A855F7','#0EA5E9','#FB7185'];
  const CAT_COLORS = {};
  let _ci = 0;
  function getCatColor(cat) { if (!CAT_COLORS[cat]) { CAT_COLORS[cat] = PALETTE[_ci % PALETTE.length]; _ci++; } return CAT_COLORS[cat]; }

  let chart=null, cotacao=null, allItens=[], approved=false, totalProdutos=0, areaFactor=1;

  const fmtBRL      = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtDate     = s => !s ? '—' : new Date(s).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fmtDateTime = s => !s ? '—' : new Date(s).toLocaleString('pt-BR');
  const esc         = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  async function rpc(fn,params){
    const r=await fetch(SUPABASE_URL+'/rest/v1/rpc/'+fn,{method:'POST',headers:{apikey:SUPABASE_ANON,Authorization:'Bearer '+SUPABASE_ANON,'Content-Type':'application/json'},body:JSON.stringify(params)});
    if(!r.ok) throw new Error('Erro na comunicação com servidor.');
    return r.json();
  }
  function showError(msg){
    document.getElementById('state-loading').style.display='none';
    document.getElementById('state-error').style.display='flex';
    if(msg) document.getElementById('err-title').textContent=msg;
  }
  function addMeta(key,val,full){
    const g=document.getElementById('meta-grid');
    const c=document.createElement('div');
    c.className='meta-cell'+(full?' full':'');
    c.innerHTML='<div class="meta-key">'+key+'</div><div class="meta-val">'+esc(String(val||'—'))+'</div>';
    g.appendChild(c);
  }

  /* ── Extrai principio_ativo, fonte, empresa de um item ── */
  function getDetails(it){
    const excelData=cotacao.excel_itens_json||[];
    const orig=excelData.find(x=>String(x.produto||'').trim()===String(it.produto_nome||'').trim())||{};
    /* colunas próprias têm prioridade (após fix do PlanilhaScreen) */
    const pa      = it.principio_ativo || orig.ia || orig.principio_ativo || '';
    const fonte   = it.fonte           || orig.fonte || '';
    const empresa = orig.empresa || orig.fabricante || orig.marca || '';
    const d=[];
    if(empresa) d.push({k:'Empresa',   v:empresa});
    if(pa)      d.push({k:'P. Ativo',  v:pa});
    if(fonte)   d.push({k:'Fontes',    v:fonte});
    if(it.dose_ha!=null&&String(it.dose_ha)!=='')
      d.push({k:'Dose',v:String(it.dose_ha)+(it.unidade?' '+it.unidade:'')});
    /* demais colunas extras do excel */
    const ignore=['produto','fornecedor','categoria','valor_ha','unidade','dose','id','cotacao_id','quantidade','preco_unitario','preco_referencia','desconto_pct','total','opcao_num','ia','principio_ativo','fonte','empresa','fabricante','marca'];
    Object.keys(orig).forEach(k=>{if(!ignore.includes(k)&&orig[k]) d.push({k,v:orig[k]});});
    return d;
  }

  function chipHtml(d,cls){
    return d.map(x=>'<span class="'+cls+'"><span style="opacity:.55;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em">'+esc(x.k)+'</span> <b>'+esc(String(x.v))+'</b></span>').join('');
  }

  function buildChart(labels,values,colors){
    const ctx=document.getElementById('donut').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:colors,borderColor:'#040404',borderWidth:3,hoverOffset:8}]},options:{cutout:'80%',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>' R$ '+fmtBRL(c.parsed)}}},animation:{duration:700,easing:'easeInOutQuart'}}});
  }
  function buildLegend(entries,colors,total){
    const el=document.getElementById('chart-legend');
    el.innerHTML='';
    if(!entries.length) return;
    entries.forEach(([cat,val],i)=>{
      const pct=total>0?(val/total*100):0;
      const row=document.createElement('div');
      row.className='legend-row';
      row.innerHTML='<div class="legend-dot" style="background:'+colors[i]+'"></div>'
        +'<div class="legend-name">'+esc(cat)+' <span style="color:var(--text-mid)">('+pct.toFixed(1)+'%)</span></div>'
        +'<div class="legend-bar-wrap"><div class="legend-bar" style="width:'+pct.toFixed(1)+'%;background:'+colors[i]+'"></div></div>'
        +'<div class="legend-val" style="color:'+colors[i]+'">R$ '+fmtBRL(val)+'</div>';
      el.appendChild(row);
    });
  }

  function renderProdutos(itens){
    const byCat={};
    itens.forEach(it=>{
      if(!it.produto_nome) return;
      const cat=it.categoria||'Insumo';
      if(!byCat[cat]) byCat[cat]={};
      if(!byCat[cat][it.produto_nome]) byCat[cat][it.produto_nome]=[];
      byCat[cat][it.produto_nome].push(it);
    });
    const container=document.getElementById('prod-list');
    container.innerHTML='';

    const catEntries=Object.entries(byCat).map(([cat,prods])=>{
      const catTotal=Object.keys(prods).reduce((s,p)=>{
        const sv=[...prods[p]].sort((a,b)=>(a.valor_ha||0)-(b.valor_ha||0));
        return s+Number(sv[0]?.valor_ha||0);
      },0);
      return{cat,prods,catTotal};
    });

    catEntries.sort((a,b)=>b.catTotal-a.catTotal).forEach(({cat,prods,catTotal})=>{
      const color=getCatColor(cat);
      const prodNames=Object.keys(prods);
      const catAllOpts=Object.values(prods).flatMap(o=>o);
      const catMin=catAllOpts.reduce((acc,it)=>(!acc||Number(it.valor_ha||0)<Number(acc.valor_ha||0)?it:acc),null);
      const catMax=catAllOpts.reduce((acc,it)=>(!acc||Number(it.valor_ha||0)>Number(acc.valor_ha||0)?it:acc),null);

      const section=document.createElement('div');
      section.className='cat-section';

      const hdr=document.createElement('div');
      hdr.className='cat-section-header';
      hdr.innerHTML='<div class="cat-color-bar" style="background:'+color+'"></div>'
        +'<div class="cat-section-dot" style="background:'+color+'"></div>'
        +'<span class="cat-section-title">'+esc(cat)+'</span>'
        +'<span class="cat-section-count">'+prodNames.length+' produto(s)</span>'
        +'<span class="cat-section-min">R$ '+fmtBRL(catTotal)+'</span>';
      section.appendChild(hdr);

      Object.entries(prods).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([nome,opts])=>{
        const sorted=[...opts].sort((a,b)=>(a.valor_ha||0)-(b.valor_ha||0));
        const group=document.createElement('div');
        group.className='prod-group';

        /* chips do cabeçalho do produto: empresa, P.A., fontes */
        const refDetails=getDetails(sorted[0]);
        const groupDetails=refDetails.filter(d=>['Empresa','P. Ativo','Fontes'].includes(d.k));
        const groupChips=groupDetails.map(d=>'<div class="prod-chip"><span class="prod-chip-key">'+esc(d.k)+'</span><span style="margin:0 3px;color:var(--text-low)">·</span><span class="prod-chip-val">'+esc(d.v)+'</span></div>').join('');

        let html='<div class="prod-group-title">'+esc(nome)+'</div>'
          +(groupChips?'<div class="prod-chips">'+groupChips+'</div>':'');

        sorted.forEach(it=>{
          const isMin=!!catMin&&String(it.id)===String(catMin.id);
          const isMax=!!catMax&&String(it.id)===String(catMax.id)&&(!catMin||String(catMax.id)!==String(catMin.id));
          /* chips menores por opção — só dose e extras */
          const itDetails=getDetails(it).filter(d=>!['Empresa','P. Ativo','Fontes'].includes(d.k));
          const subChips=chipHtml(itDetails,'option-sub-chip');

          html+='<div class="option-card'+(isMin?' cheapest':'')+(isMax?' expensive':'')+'">'
            +'<div class="option-info">'
              +'<div class="option-forn">'+esc(it.fornecedor||'Fornecedor Direto')+'</div>'
              +(subChips?'<div class="option-sub-chips">'+subChips+'</div>':'')
            +'</div>'
            +'<div class="option-price-col">'
              +'<div class="option-price" style="color:'+color+'">R$ '+fmtBRL(it.valor_ha||0)+'</div>'
              +(isMin?'<span class="badge-menor">Menor</span>':'')
              +(isMax?'<span class="badge-maior">Maior</span>':'')
            +'</div>'
          +'</div>';
        });
        group.innerHTML=html;
        section.appendChild(group);
      });
      container.appendChild(section);
    });
  }

  function totalSelecionado(){
    const m={};
    allItens.forEach(it=>{
      const cat=it.categoria||'Insumo',prod=it.produto_nome;
      if(!prod) return;
      if(!m[cat]) m[cat]={};
      if(!m[cat][prod]) m[cat][prod]=[];
      m[cat][prod].push(Number(it.valor_ha||0));
    });
    let t=0;
    Object.values(m).forEach(pm=>Object.values(pm).forEach(vals=>{const s=[...vals].sort((a,b)=>a-b);t+=s[0]||0;}));
    return t;
  }

  function sync(){
    const total=totalSelecionado(),count=allItens.length;
    document.getElementById('footer-total').textContent='R$ '+fmtBRL(total);
    document.getElementById('center-total').textContent='R$ '+fmtBRL(total);
    document.getElementById('footer-count').textContent=totalProdutos+' produtos ('+count+' opções)';
    document.getElementById('btn-aceite').disabled=count===0||approved;

    const m={};
    allItens.forEach(it=>{
      const cat=it.categoria||'Insumo',prod=it.produto_nome;
      if(!prod) return;
      if(!m[cat]) m[cat]={};
      if(!m[cat][prod]) m[cat][prod]=[];
      m[cat][prod].push(Number(it.valor_ha||0));
    });
    const sByCat={};
    Object.entries(m).forEach(([cat,pm])=>{
      sByCat[cat]=0;
      Object.values(pm).forEach(vals=>{const s=[...vals].sort((a,b)=>a-b);sByCat[cat]+=s[0]||0;});
    });
    const donutRows=Object.entries(sByCat).map(([cat,value])=>({cat,value})).filter(r=>r.value>0).sort((a,b)=>b.value-a.value);
    const donutEntries=donutRows.map(r=>[r.cat,r.value]);
    const colors=donutEntries.map(([c])=>getCatColor(c));
    if(!donutEntries.length){buildChart(['Sem itens'],[1],['#1e1e1e']);buildLegend([],[],0);}
    else{buildChart(donutEntries.map(e=>e[0]),donutEntries.map(e=>e[1]),colors);buildLegend(donutEntries,colors,donutEntries.reduce((a,[,v])=>a+v,0));}
  }

  /* Modal aceite — com chips de principio_ativo e fonte */
  function abrirModal(){
    if(allItens.length===0){alert('Não há itens para confirmar.');return;}
    const total=totalSelecionado();
    const el=document.getElementById('modal-summary');
    el.innerHTML='';
    const used=new Set();
    [...allItens].sort((a,b)=>(a.valor_ha||0)-(b.valor_ha||0)).forEach(it=>{
      const key=(it.categoria||'Insumo')+'||'+it.produto_nome;
      if(used.has(key)) return;
      used.add(key);
      const details=getDetails(it);
      const chipsHtml=chipHtml(details,'modal-chip');
      const row=document.createElement('div');
      row.className='modal-item';
      row.innerHTML='<div class="modal-item-top">'
        +'<div class="modal-item-name">'+esc(it.categoria||'Insumo')+' — '+esc(it.produto_nome||'Produto')+'</div>'
        +'<div class="modal-item-price">R$ '+fmtBRL(it.valor_ha||0)+'</div>'
        +'</div>'
        +(chipsHtml?'<div class="modal-item-chips">'+chipsHtml+'</div>':'');
      el.appendChild(row);
    });
    document.getElementById('modal-total-val').textContent='R$ '+fmtBRL(total);
    document.getElementById('modal-backdrop').classList.add('open');
  }
  function fecharModal(){document.getElementById('modal-backdrop').classList.remove('open');}
  function fecharModalExterno(e){if(e.target===document.getElementById('modal-backdrop')) fecharModal();}
  function abrirModalRecusa(){if(!approved) document.getElementById('modal-recusar-backdrop').classList.add('open');}
  function fecharModalRecusa(){document.getElementById('modal-recusar-backdrop').classList.remove('open');}
  function fecharModalRecusaExterno(e){if(e.target===document.getElementById('modal-recusar-backdrop')) fecharModalRecusa();}

  async function confirmarAceite(){
    const btn=document.getElementById('btn-confirm-modal');
    btn.disabled=true;btn.textContent='Registrando...';
    try{
      await rpc('registrar_aceite_cotacao',{p_cotacao_id:cotacao.id,p_itens:[],p_total_ha:totalSelecionado(),p_user_agent:navigator.userAgent});
      fecharModal();setAprovado(new Date().toISOString());
    }catch(e){alert('Erro ao registrar o aceite.');}
    finally{btn.disabled=false;btn.textContent='Confirmar Aceite';}
  }
  function setAprovado(ts){
    approved=true;
    document.getElementById('status-pill').textContent='Aceite registrado';
    document.getElementById('status-pill').className='status-pill aprovado';
    document.getElementById('approved-banner').classList.remove('recusado');
    document.querySelector('#approved-banner .approved-title').textContent='Aceite Registrado';
    document.getElementById('approved-banner').style.display='block';
    document.getElementById('approved-ts').textContent='Registrado em '+fmtDateTime(ts);
    document.getElementById('sticky-footer').style.display='none';
  }
  async function confirmarRecusa(){
    const btn=document.getElementById('btn-recusar-modal');
    btn.disabled=true;btn.textContent='Registrando...';
    try{
      await rpc('registrar_recusa_cotacao',{p_cotacao_id:cotacao.id,p_user_agent:navigator.userAgent});
      fecharModalRecusa();setRecusado(new Date().toISOString());
    }catch(e){alert('Erro ao recusar.');}
    finally{btn.disabled=false;btn.textContent='Confirmar Recusa';}
  }
  function setRecusado(ts){
    approved=true;
    document.getElementById('status-pill').textContent='Recusada';
    document.getElementById('status-pill').className='status-pill recusado';
    document.getElementById('approved-banner').classList.add('recusado');
    document.querySelector('#approved-banner .approved-title').textContent='Cotação Recusada';
    document.getElementById('approved-banner').style.display='block';
    document.getElementById('approved-ts').textContent='Registrado em '+fmtDateTime(ts);
    document.getElementById('sticky-footer').style.display='none';
  }

  async function main(){
    const params=new URLSearchParams(window.location.search);
    const token=params.get('t')||params.get('token');
    if(!token){showError('Token não encontrado na URL.');return;}
    try{
      const cotRows=await rpc('get_cotacao_by_token',{p_token:token});
      if(!cotRows||cotRows.length===0){showError('Cotação não encontrada.');return;}
      cotacao=cotRows[0];

      let consultorNome='—',fazendaNome='—';
      try{const p=await rpc('get_profile_name',{p_id:cotacao.consultor_id});if(p&&p[0])consultorNome=p[0].full_name||'—';}catch(_){}
      if(cotacao.fazenda_id){
        try{const f=await rpc('get_fazenda_by_id',{p_id:cotacao.fazenda_id});if(f&&f[0])fazendaNome=f[0].nome||'—';}catch(_){}
      }

      allItens=await rpc('get_itens_by_cotacao',{p_cotacao_id:cotacao.id});
      const areaManual=Number(cotacao?.area_ha||0),areaTalhao=Number(cotacao?.talhao_area_ha||0);
      const areaFinal=areaManual>0?areaManual:(areaTalhao>0?areaTalhao:0);
      if(areaFinal>0){areaFactor=areaFinal;allItens=(allItens||[]).map(it=>({...it,valor_ha:Number(it?.valor_ha||0)*areaFactor}));}
      else{areaFactor=1;}

      const aceiteEm=cotacao.aceite_em||cotacao.approved_at;
      document.title=cotacao.titulo||'Cotação Agrocota';
      document.getElementById('meta-titulo').textContent=cotacao.titulo||'Cotação';

      /* Fazenda em linha inteira (full) */
      addMeta('Fazenda',fazendaNome,true);
      if(areaFinal>0) addMeta('Área',fmtBRL(areaFinal)+' ha');
      addMeta('Data',fmtDate(cotacao.created_at));
      addMeta('Consultor',consultorNome);

      if(cotacao.status==='recusada'){setRecusado(aceiteEm||new Date().toISOString());}
      else if(cotacao.status==='aprovada'||cotacao.status==='aprovado'||aceiteEm){setAprovado(aceiteEm||new Date().toISOString());}

      totalProdutos=new Set(allItens.map(it=>it.produto_nome)).size;
      renderProdutos(allItens);
      sync();
      document.getElementById('state-loading').style.display='none';
      document.getElementById('app').style.display='block';
    }catch(e){showError('Erro ao carregar os dados.');}
  }
  main();
</script>
</body>
</html>
