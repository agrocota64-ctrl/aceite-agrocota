<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agrocota - Comparativo de Decisão</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:          #040404;
      --surface:     #0e0e0e;
      --surface2:    #161616;
      --border:      #1e1e1e;
      --border2:     #2a2a2a;
      --primary:     #22c55e;
      --primary-dim: #021a09;
      --text:        #f0f0f0;
      --text-mid:    #666;
      --text-low:    #333;
      --red:         #ef4444;
      --amber:       #f59e0b;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }

    /* ── STATES ── */
    #state-loading, #state-error {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100svh; gap: 16px;
    }
    #state-error { padding: 32px; text-align: center; }
    .loader { width: 32px; height: 32px; border: 2px solid var(--border2); border-top-color: var(--primary); border-radius: 50%; animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .state-label { font-size: .7rem; font-weight: 700; letter-spacing: .1em; color: var(--text-mid); text-transform: uppercase; }
    .err-title { font-size: .95rem; font-weight: 800; color: var(--red); }
    .err-body  { font-size: .78rem; color: var(--text-mid); margin-top: 6px; }

    /* ── TOP BAR — idêntico ao index ── */
    .top-bar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(4,4,4,.88);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      padding: 13px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-size: .68rem; font-weight: 900; letter-spacing: .2em; color: var(--primary); text-transform: uppercase; }
    .status-pill {
      font-size: .58rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase;
      padding: 4px 10px; border-radius: 100px; border: 1px solid var(--border2); color: var(--text-mid);
    }
    .status-pill.pendente { border-color: var(--amber); color: var(--amber); }
    .status-pill.aprovado { border-color: var(--primary); color: var(--primary); }

    /* ── PAGE ── */
    .page { max-width: 620px; margin: 0 auto; padding: 28px 16px 150px; }

    /* ── META — idêntico ao index ── */
    .meta-block { margin-bottom: 36px; }
    .meta-title { font-size: 1.5rem; font-weight: 900; line-height: 1.2; letter-spacing: -.02em; margin-bottom: 18px; }
    .meta-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 1px; background: var(--border);
      border: 1px solid var(--border); border-radius: 14px; overflow: hidden;
    }
    @media (max-width: 380px) { .meta-grid { grid-template-columns: 1fr; } }
    .meta-cell { background: var(--surface); padding: 12px 14px; }
    .meta-key { font-size: .6rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 3px; }
    .meta-val { font-size: .88rem; font-weight: 600; color: var(--text); }

    /* ── SECTION HEADER — idêntico ao index ── */
    .section-hd { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; margin-top: 36px; }
    .section-hd h2 { font-size: .62rem; font-weight: 800; letter-spacing: .14em; text-transform: uppercase; color: var(--text-mid); white-space: nowrap; }
    .section-line { flex: 1; height: 1px; background: var(--border); }

    /* ── DONUT — idêntico ao index ── */
    .chart-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px 20px;
      display: flex; flex-direction: column; align-items: center; gap: 28px;
    }
    .chart-canvas-wrap { position: relative; width: 190px; height: 190px; flex-shrink: 0; }
    canvas#donut { width: 190px !important; height: 190px !important; }
    .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; pointer-events: none; }
    .chart-center-label { font-size: .55rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .chart-center-value { font-family: 'JetBrains Mono', monospace; font-size: .95rem; font-weight: 700; color: var(--text); display: block; line-height: 1.3; }
    .chart-legend { width: 100%; display: flex; flex-direction: column; gap: 9px; }
    .legend-row { display: flex; align-items: center; gap: 10px; }
    .legend-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .legend-name { flex: 1; font-size: .76rem; font-weight: 600; color: var(--text); }
    .legend-bar-wrap { flex: 1.5; height: 3px; background: var(--border2); border-radius: 99px; overflow: hidden; }
    .legend-bar { height: 100%; border-radius: 99px; transition: width .6s cubic-bezier(.4,0,.2,1); }
    .legend-val { font-family: 'JetBrains Mono', monospace; font-size: .72rem; font-weight: 700; min-width: 82px; text-align: right; }

    /* ── BAR CHART — mesmo container que o donut ── */
    .bar-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px 20px;
    }

    /* ── CATEGORY SECTIONS (proposta) — idêntico ao index ── */
    .cat-section { margin-bottom: 28px; }
    .cat-section-header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px 10px;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 12px; position: relative; overflow: hidden;
      margin-bottom: 10px;
    }
    .cat-section-dot   { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .cat-section-title { font-size: .88rem; font-weight: 900; color: var(--text); flex: 1; }
    .cat-section-count { font-size: .6rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .cat-section-min   { font-family: 'JetBrains Mono', monospace; font-size: .72rem; font-weight: 700; color: var(--primary); white-space: nowrap; }

    /* ── OPTION CARDS — idêntico ao index ── */
    .option-card {
      display: flex; align-items: center; gap: 12px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px; margin-bottom: 8px;
      cursor: pointer; transition: border-color .18s, background .18s, transform .12s;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .option-card:active { transform: scale(.98); }
    .option-card.selected { border-color: var(--primary); background: var(--primary-dim); }
    .option-badge {
      font-size: .54rem; font-weight: 900; letter-spacing: .08em; text-transform: uppercase;
      padding: 3px 7px; border-radius: 6px; background: var(--primary); color: #000;
      opacity: 0; flex-shrink: 0; transition: opacity .2s;
    }
    .option-card.menor .option-badge { opacity: 1; }
    .option-info { flex: 1; min-width: 0; }
    .option-forn { font-size: .83rem; font-weight: 700; }
    .option-cat  { font-size: .63rem; font-weight: 600; color: var(--text-mid); margin-top: 3px; }
    .option-price-col { text-align: right; flex-shrink: 0; }
    .option-price { font-family: 'JetBrains Mono', monospace; font-size: .95rem; font-weight: 700; }

    /* pills de produto dentro do card */
    .prod-pill-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .prod-pill { font-size: .62rem; font-weight: 600; padding: 4px 8px; background: var(--surface2); border: 1px solid var(--border2); border-radius: 6px; color: var(--text-mid); }

    /* ── APPROVED BANNER — idêntico ao index ── */
    .approved-card { background: var(--primary-dim); border: 1px solid var(--primary); border-radius: 18px; padding: 22px; text-align: center; margin-bottom: 28px; }
    .approved-title { font-size: .95rem; font-weight: 900; color: var(--primary); margin-bottom: 5px; }
    .approved-sub   { font-size: .75rem; color: var(--text-mid); }
    .approved-ts    { font-family: 'JetBrains Mono', monospace; font-size: .68rem; color: var(--primary); margin-top: 8px; }

    /* ── STICKY FOOTER — idêntico ao index ── */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      padding: 14px 16px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, var(--bg) 65%, transparent);
    }
    .footer-inner { max-width: 620px; margin: 0 auto; }
    .total-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; padding: 0 2px; }
    .total-label-sm { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .total-amount { font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 700; color: var(--text); }
    .total-sub { font-size: .58rem; color: var(--text-mid); text-align: right; display: block; }
    .btn-confirm {
      width: 100%; background: var(--primary); color: #000; border: none;
      padding: 16px 24px; border-radius: 15px; font-family: 'Inter', sans-serif; font-size: .75rem; font-weight: 900;
      letter-spacing: .1em; text-transform: uppercase; cursor: pointer;
      transition: opacity .18s, transform .12s; box-shadow: 0 0 40px rgba(34,197,94,.12);
    }
    .btn-confirm:active { transform: scale(.97); }
    .btn-confirm:disabled { opacity: .3; cursor: not-allowed; box-shadow: none; }

    /* ── MODAL — idêntico ao index ── */
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: flex-end; justify-content: center; padding: 16px;
      opacity: 0; pointer-events: none; transition: opacity .25s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 24px; padding: 26px 22px; width: 100%; max-width: 600px;
      transform: translateY(24px); transition: transform .3s cubic-bezier(.4,0,.2,1);
    }
    .modal-backdrop.open .modal { transform: translateY(0); }
    .modal-title { font-size: .95rem; font-weight: 900; margin-bottom: 5px; }
    .modal-sub   { font-size: .75rem; color: var(--text-mid); margin-bottom: 20px; }
    .modal-summary { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 14px; margin-bottom: 16px; max-height: 240px; overflow-y: auto; }
    .modal-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .modal-item:last-child { border-bottom: none; }
    .modal-item-name  { font-size: .78rem; font-weight: 600; }
    .modal-item-forn  { font-size: .63rem; color: var(--text-mid); margin-top: 2px; }
    .modal-item-price { font-family: 'JetBrains Mono', monospace; font-size: .76rem; font-weight: 700; color: var(--primary); flex-shrink: 0; margin-left: 12px; }
    .modal-total { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; padding-top: 12px; border-top: 1px solid var(--border2); }
    .modal-total-label { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .modal-total-val   { font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 900; color: var(--text); }
    .modal-actions { display: flex; gap: 10px; margin-top: 16px; }
    .btn-cancel {
      flex: 1; background: transparent; border: 1px solid var(--border2); color: var(--text-mid);
      padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif;
      font-size: .72rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase;
      cursor: pointer; transition: background .18s;
    }
    .btn-cancel:hover { background: var(--border); }
    .btn-confirm-modal {
      flex: 2; background: var(--primary); color: #000; border: none;
      padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif;
      font-size: .72rem; font-weight: 900; letter-spacing: .1em; text-transform: uppercase;
      cursor: pointer; transition: opacity .18s;
    }
    .btn-confirm-modal:disabled { opacity: .5; cursor: not-allowed; }

    .page-footer { text-align: center; padding: 12px 16px; font-size: .6rem; color: var(--text-low); letter-spacing: .06em; text-transform: uppercase; }
  </style>
</head>
<body>

<div id="state-loading">
  <div class="loader"></div>
  <span class="state-label">Carregando comparativo</span>
</div>
<div id="state-error" style="display:none">
  <span class="err-title" id="err-title">Dados não encontrados</span>
  <p class="err-body" id="err-body">Solicite um novo link ao consultor responsável.</p>
</div>

<div id="app" style="display:none">
  <div class="top-bar">
    <span class="brand">Agrocota</span>
    <span class="status-pill pendente" id="status-pill">Aguardando aceite</span>
  </div>

  <main class="page">
    <div class="meta-block">
      <h1 class="meta-title" id="meta-titulo">Comparativo de Cotação</h1>
      <div class="meta-grid" id="meta-grid"></div>
    </div>

    <div class="approved-card" id="approved-banner" style="display:none">
      <div class="approved-title">Aceite Registrado</div>
      <div class="approved-sub">Seu consultor foi notificado. Obrigado pela confirmação.</div>
      <div class="approved-ts" id="approved-ts"></div>
    </div>

    <!-- DONUT: composição de custo da proposta selecionada -->
    <div class="section-hd">
      <h2>Composição de Custo</h2>
      <div class="section-line"></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-canvas-wrap">
        <canvas id="donut"></canvas>
        <div class="chart-center">
          <span class="chart-center-label">Investimento</span>
          <span class="chart-center-value" id="center-total">R$ 0,00</span>
        </div>
      </div>
      <div class="chart-legend" id="chart-legend"></div>
    </div>

    <!-- BAR CHART: produto × cotação -->
    <div class="section-hd" style="margin-top:44px">
      <h2>Comparativo por Produto</h2>
      <div class="section-line"></div>
    </div>
    <div class="bar-wrap">
      <canvas id="barChart"></canvas>
    </div>

    <!-- SELEÇÃO DE PROPOSTA -->
    <div class="section-hd" style="margin-top:44px">
      <h2>Selecione a Proposta</h2>
      <div class="section-line"></div>
    </div>
    <div id="opcao-list"></div>
  </main>

  <div class="sticky-footer" id="sticky-footer">
    <div class="footer-inner">
      <div class="total-row">
        <div>
          <div class="total-label-sm">Proposta Selecionada</div>
          <span class="total-sub" id="footer-sub">Nenhuma selecionada</span>
        </div>
        <div style="text-align:right">
          <div class="total-amount" id="footer-total">—</div>
        </div>
      </div>
      <button class="btn-confirm" id="btn-aceite" onclick="abrirModal()" disabled>Confirmar Aceite da Proposta</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAÇÃO -->
<div class="modal-backdrop" id="modal-backdrop" onclick="fecharModalExterno(event)">
  <div class="modal">
    <div class="modal-title">Confirmar Aceite</div>
    <div class="modal-sub">Você está aprovando a proposta abaixo. Esta ação será registrada com data, hora e dispositivo.</div>
    <div class="modal-summary" id="modal-summary"></div>
    <div class="modal-total">
      <span class="modal-total-label">Investimento Total</span>
      <span class="modal-total-val" id="modal-total-val">R$ 0,00</span>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModal()">Voltar</button>
      <button class="btn-confirm-modal" id="btn-confirm-modal" onclick="confirmarAceite()">Confirmar Aceite</button>
    </div>
  </div>
</div>

<footer class="page-footer">Agrocota 2025 &mdash; Plataforma de Decisão Agrícola</footer>

<script>
  /* ══════════════════════════════════════════════════════
     CONFIG — idêntico ao index.html
  ══════════════════════════════════════════════════════ */
  const SUPABASE_URL  = 'https://fafjknchnibdflpqyssf.supabase.co';
  const SUPABASE_ANON = 'sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r';

  const PALETTE = [
    '#3B82F6','#EF4444','#F59E0B','#10B981',
    '#8B5CF6','#06B6D4','#EC4899','#84CC16',
    '#F97316','#14B8A6','#6366F1','#EAB308',
    '#22C55E','#A855F7','#0EA5E9','#FB7185',
  ];

  /* cor por índice de cotação */
  const _cotColors = {};
  let _cotIdx = 0;
  function getCotColor(key) {
    if (_cotColors[key] === undefined) _cotColors[key] = PALETTE[_cotIdx++ % PALETTE.length];
    return _cotColors[key];
  }

  /* cor por nome de produto (donut) */
  const _prodColors = {};
  let _prodIdx = 0;
  function getProdColor(nome) {
    if (!_prodColors[nome]) _prodColors[nome] = PALETTE[_prodIdx++ % PALETTE.length];
    return _prodColors[nome];
  }

  const fmtBRL      = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtDate     = s => !s ? '—' : new Date(s).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fmtDateTime = s => !s ? '—' : new Date(s).toLocaleString('pt-BR');
  const esc         = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  async function rpc(fn, body) {
    const r = await fetch(SUPABASE_URL + '/rest/v1/rpc/' + fn, {
      method: 'POST',
      headers: { apikey: SUPABASE_ANON, Authorization: 'Bearer ' + SUPABASE_ANON, 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!r.ok) throw new Error('RPC error: ' + fn);
    return r.json();
  }

  function showError(msg, sub) {
    document.getElementById('state-loading').style.display = 'none';
    document.getElementById('state-error').style.display   = 'flex';
    if (msg) document.getElementById('err-title').textContent = msg;
    if (sub) document.getElementById('err-body').textContent  = sub;
  }

  function addMeta(key, val) {
    const g = document.getElementById('meta-grid');
    const c = document.createElement('div');
    c.className = 'meta-cell';
    c.innerHTML = '<div class="meta-key">' + key + '</div><div class="meta-val">' + esc(String(val||'—')) + '</div>';
    g.appendChild(c);
  }

  /* ══ estado ══ */
  let cotacao     = null;
  let payload     = null;   /* dados do ?data= BASE64 */
  let selecionado = null;
  let approved    = false;
  let donutChart  = null;
  let barChart    = null;

  /* ══ DONUT: composição por produto de uma cotação ══ */
  function buildDonut(cotacaoItem) {
    const ctx = document.getElementById('donut').getContext('2d');
    if (donutChart) donutChart.destroy();

    /* cotacaoItem.produtos = [{nome, precos:[v1,v2,...]}]
       usamos o primeiro preço (índice 0) como valor desta cotação */
    const cotIdx = payload.cotacoes.indexOf(cotacaoItem);
    const labels = (cotacaoItem.produtos || payload.produtos || []).map(p => p.nome);

    /* pega o preço desta cotação para cada produto */
    const values = (payload.produtos || []).map(p => {
      return p.precos && p.precos[cotIdx] != null ? Number(p.precos[cotIdx]) : 0;
    });

    /* fallback: se a cotação já tiver produtos próprios com preços */
    const labelsF = labels.length ? labels : (payload.produtos||[]).map(p=>p.nome);
    const valuesF = values.filter(v => v > 0).length ? values : labelsF.map(()=>0);

    const colors = labelsF.map(l => getProdColor(l));
    const total  = valuesF.reduce((a, b) => a + b, 0);

    document.getElementById('center-total').textContent = 'R$ ' + fmtBRL(cotacaoItem.total || total);

    donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: { labels: labelsF, datasets: [{ data: valuesF, backgroundColor: colors, borderColor: '#040404', borderWidth: 3, hoverOffset: 8 }] },
      options: {
        cutout: '80%',
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ' R$ ' + fmtBRL(c.parsed) } } },
        animation: { duration: 700, easing: 'easeInOutQuart' },
      }
    });

    /* legenda — idêntica ao index */
    const el = document.getElementById('chart-legend');
    el.innerHTML = '';
    labelsF.forEach((nome, i) => {
      const pct = total > 0 ? (valuesF[i] / total * 100) : 0;
      const row = document.createElement('div');
      row.className = 'legend-row';
      row.innerHTML =
        '<div class="legend-dot" style="background:' + colors[i] + '"></div>'
        + '<div class="legend-name">' + esc(nome) + ' <span style="color:var(--text-mid)">(' + pct.toFixed(1) + '%)</span></div>'
        + '<div class="legend-bar-wrap"><div class="legend-bar" style="width:' + pct.toFixed(1) + '%;background:' + colors[i] + '"></div></div>'
        + '<div class="legend-val" style="color:' + colors[i] + '">R$ ' + fmtBRL(valuesF[i]) + '</div>';
      el.appendChild(row);
    });
  }

  /* ══ BAR CHART: produto × cotação ══
     payload.produtos = [{nome, precos:[cotA, cotB, ...]}]
     payload.cotacoes = [{titulo, total}]
  ══ */
  function buildBarChart() {
    const ctx = document.getElementById('barChart').getContext('2d');
    if (barChart) barChart.destroy();

    const produtos  = (payload.produtos || []).map(p => p.nome);
    const datasets  = payload.cotacoes.map((c, ci) => ({
      label: c.titulo,
      data: (payload.produtos || []).map(p => p.precos && p.precos[ci] != null ? Number(p.precos[ci]) : 0),
      backgroundColor: getCotColor(ci),
      borderRadius: 8,
      barThickness: 22,
    }));

    const barH   = 26 * payload.cotacoes.length + 12;
    const totalH = Math.max(160, produtos.length * barH + 80);
    document.getElementById('barChart').style.height = totalH + 'px';

    barChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: produtos, datasets },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: {
            display: true, position: 'bottom',
            labels: { color: '#f0f0f0', font: { family: 'Inter', weight: '700', size: 11 }, boxWidth: 10, borderRadius: 4, padding: 16 }
          },
          tooltip: { callbacks: { label: c => ' ' + c.dataset.label + ': R$ ' + fmtBRL(c.parsed.x) } }
        },
        scales: {
          x: {
            grid: { color: '#1e1e1e' },
            ticks: { color: '#666', font: { family: 'JetBrains Mono', size: 10 }, callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR',{minimumFractionDigits:0}) }
          },
          y: { ticks: { color: '#f0f0f0', font: { weight: '800', family: 'Inter', size: 11 } } }
        }
      }
    });
  }

  /* ══ CARDS DE SELEÇÃO ══ */
  function renderOpcoes() {
    const container = document.getElementById('opcao-list');
    container.innerHTML = '';

    const minTotal = Math.min(...payload.cotacoes.map(c => c.total));

    payload.cotacoes.forEach((c, ci) => {
      const color   = getCotColor(ci);
      const isMenor = c.total === minTotal;

      const section = document.createElement('div');
      section.className = 'cat-section';

      /* header — idêntico ao cat-section-header do index, com borda colorida no topo */
      const hdr = document.createElement('div');
      hdr.className = 'cat-section-header';
      hdr.style.borderTop = '3px solid ' + color;
      hdr.innerHTML =
          '<div class="cat-section-dot" style="background:' + color + '"></div>'
        + '<span class="cat-section-title">' + esc(c.titulo) + '</span>'
        + (isMenor ? '<span class="cat-section-count" style="color:var(--primary)">Menor preço</span>' : '<span class="cat-section-count">&nbsp;</span>')
        + '<span class="cat-section-min">R$ ' + fmtBRL(c.total) + '</span>';
      section.appendChild(hdr);

      /* card clicável com produtos */
      const card = document.createElement('div');
      card.className = 'option-card' + (isMenor ? ' menor' : '');

      const pills = (payload.produtos || []).map(p => {
        const val = p.precos && p.precos[ci] != null ? Number(p.precos[ci]) : 0;
        return '<span class="prod-pill">' + esc(p.nome) + ' — R$ ' + fmtBRL(val) + '</span>';
      }).join('');

      card.innerHTML =
          '<div class="option-info">'
          + '<div class="option-forn" style="color:' + color + '">' + esc(c.titulo) + '</div>'
          + '<div class="prod-pill-list">' + pills + '</div>'
        + '</div>'
        + '<div class="option-price-col">'
          + '<div class="option-price" style="color:' + color + '">R$ ' + fmtBRL(c.total) + '</div>'
        + '</div>'
        + '<div class="option-badge">Menor</div>';

      card.onclick = () => selecionar(c, ci, card);
      section.appendChild(card);
      container.appendChild(section);
    });
  }

  function selecionar(c, ci, card) {
    if (approved) return;
    document.querySelectorAll('#opcao-list .option-card').forEach(el => el.classList.remove('selected'));
    card.classList.add('selected');
    selecionado = { cotacao: c, idx: ci };
    document.getElementById('footer-sub').textContent   = c.titulo;
    document.getElementById('footer-total').textContent = 'R$ ' + fmtBRL(c.total);
    document.getElementById('btn-aceite').disabled      = false;
    buildDonut(c);
  }

  /* ══ MODAL ══ */
  function abrirModal() {
    if (!selecionado) return;
    const c   = selecionado.cotacao;
    const ci  = selecionado.idx;
    const el  = document.getElementById('modal-summary');
    el.innerHTML = '';
    (payload.produtos || []).forEach(p => {
      const val = p.precos && p.precos[ci] != null ? Number(p.precos[ci]) : 0;
      const row = document.createElement('div');
      row.className = 'modal-item';
      row.innerHTML =
          '<div><div class="modal-item-name">' + esc(p.nome) + '</div></div>'
        + '<div class="modal-item-price">R$ ' + fmtBRL(val) + '</div>';
      el.appendChild(row);
    });
    document.getElementById('modal-total-val').textContent = 'R$ ' + fmtBRL(c.total);
    document.getElementById('modal-backdrop').classList.add('open');
  }
  function fecharModal() { document.getElementById('modal-backdrop').classList.remove('open'); }
  function fecharModalExterno(e) { if (e.target === document.getElementById('modal-backdrop')) fecharModal(); }

  async function confirmarAceite() {
    if (!selecionado) return;
    const btn = document.getElementById('btn-confirm-modal');
    btn.disabled = true; btn.textContent = 'Registrando...';
    try {
      await rpc('registrar_aceite_cotacao', {
        p_cotacao_id: cotacao.id,
        p_itens:      [],
        p_total_ha:   selecionado.cotacao.total,
        p_user_agent: navigator.userAgent,
      });
      fecharModal();
      setAprovado(new Date().toISOString());
    } catch(e) {
      alert('Erro ao registrar o aceite.');
    } finally {
      btn.disabled = false; btn.textContent = 'Confirmar Aceite';
    }
  }

  function setAprovado(ts) {
    approved = true;
    document.getElementById('status-pill').textContent = 'Aceite registrado';
    document.getElementById('status-pill').className   = 'status-pill aprovado';
    document.querySelector('#approved-banner .approved-title').textContent = 'Aceite Registrado';
    document.getElementById('approved-banner').style.display = 'block';
    document.getElementById('approved-ts').textContent = 'Registrado em ' + fmtDateTime(ts);
    document.getElementById('sticky-footer').style.display = 'none';
  }

  /* ══════════════════════════════════════════════════════
     MAIN — busca meta do Supabase via ?id=, lê gráficos via ?data=
  ══════════════════════════════════════════════════════ */
  async function main() {
    const params      = new URLSearchParams(window.location.search);
    const cotacaoId   = params.get('id');
    const dataEncoded = params.get('data');

    /* valida os dois parâmetros */
    if (!cotacaoId) { showError('Link inválido', 'O parâmetro "id" não foi encontrado na URL.'); return; }
    if (!dataEncoded) { showError('Dados não encontrados', 'O parâmetro "data" não foi encontrado na URL.'); return; }

    /* decodifica payload BASE64 enviado pelo app */
    try {
      payload = JSON.parse(decodeURIComponent(escape(atob(dataEncoded))));
    } catch(e) {
      showError('Erro ao decodificar dados', 'O link pode estar corrompido. Solicite um novo ao consultor.');
      return;
    }

    if (!payload.cotacoes || payload.cotacoes.length < 2) {
      showError('Comparativo inválido', 'São necessárias pelo menos 2 cotações para exibir o comparativo.');
      return;
    }

    try {
      /* 1. busca cotação base (para meta: título, fazenda, data, consultor) */
      const { data: cotRow, error: cotErr } = await fetch(
        SUPABASE_URL + '/rest/v1/cotacoes?id=eq.' + cotacaoId + '&select=*&limit=1',
        { headers: { apikey: SUPABASE_ANON, Authorization: 'Bearer ' + SUPABASE_ANON } }
      ).then(r => r.json().then(d => ({ data: d[0] || null, error: r.ok ? null : d })));

      if (!cotRow) { showError('Cotação não encontrada', 'Verifique o link ou solicite um novo ao consultor.'); return; }
      cotacao = cotRow;

      /* 2. consultor */
      let consultorNome = '—';
      try {
        const perf = await rpc('get_profile_name', { p_id: cotacao.consultor_id });
        if (perf && perf[0]) consultorNome = perf[0].full_name || '—';
      } catch(_) {}

      /* 3. fazenda */
      let fazendaNome = '—';
      if (cotacao.fazenda_id) {
        try {
          const faz = await rpc('get_fazenda_by_id', { p_id: cotacao.fazenda_id });
          if (faz && faz[0]) fazendaNome = faz[0].nome || '—';
        } catch(_) {}
      }

      /* 4. área — idêntico ao index */
      const areaManual = Number(cotacao?.area_ha || 0);
      const areaTalhao = Number(cotacao?.talhao_area_ha || 0);
      const areaFinal  = areaManual > 0 ? areaManual : (areaTalhao > 0 ? areaTalhao : 0);

      /* 5. preenche meta */
      document.title = (cotacao.titulo || 'Comparativo') + ' — Agrocota';
      document.getElementById('meta-titulo').textContent = cotacao.titulo || 'Comparativo de Cotação';
      addMeta('Fazenda',   fazendaNome);
      addMeta('Área',      areaFinal > 0 ? fmtBRL(areaFinal) + ' ha' : '—');
      addMeta('Data',      fmtDate(cotacao.created_at));
      addMeta('Consultor', consultorNome);

      /* 6. status */
      const aceiteEm = cotacao.aceite_em || cotacao.approved_at;
      if (cotacao.status === 'aprovada' || cotacao.status === 'aprovado' || aceiteEm) {
        setAprovado(aceiteEm || new Date().toISOString());
      }

      /* 7. renderiza gráficos e cards */
      const menor = [...payload.cotacoes].sort((a, b) => a.total - b.total)[0];
      /* pré-aquece as cores para manter a mesma ordem no donut e na barra */
      payload.cotacoes.forEach((_, i) => getCotColor(i));

      buildDonut(menor);
      buildBarChart();
      renderOpcoes();

      document.getElementById('state-loading').style.display = 'none';
      document.getElementById('app').style.display           = 'block';

    } catch(e) {
      showError('Erro ao carregar os dados', 'Tente novamente ou solicite um novo link ao consultor.');
    }
  }

  main();
</script>
</body>
</html>
