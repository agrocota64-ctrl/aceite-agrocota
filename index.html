import * as Print from 'expo-print';
import * as Sharing from 'expo-sharing';
import * as FileSystem from 'expo-file-system/legacy';
import { Alert } from 'react-native';
import { Asset } from 'expo-asset';

export interface PdfOpcaoFornecedor {
  fornecedor: string;
  valorHa: number;
  doseHa?: number | null;
  unidade?: string | null;
}

export interface PdfProdutoCategoria {
  produto: string;
  opcoes: PdfOpcaoFornecedor[];
}

export interface PdfCategoriaCotacao {
  categoria: string;
  color: string;
  somaMin: number;
  somaMax: number;
  produtos: PdfProdutoCategoria[];
}

export interface ExportCotacaoPdfInput {
  titulo: string;
  dataGeracao?: Date;
  totalGeralMin: number;
  totalGeralMax: number;
  economiaPotencial: number;
  categorias: PdfCategoriaCotacao[];
  fazendaNome?: string;
  produtorNome?: string;
  fazendaLocalizacao?: string;
  consultorEmpresa?: {
    companyName?: string;
    consultorNome?: string;
    cnpj?: string;
    phone?: string;
    logoUrl?: string;
  };
  comparativoCotacoes?: {
    titulo: string;
    totalGeral: number;
  }[];
  comparativoProdutos?: {
    categoria: string;
    produto: string;
    precos: {
      titulo: string;
      valor: number;
    }[];
  }[];
  excelItensJson?: Array<Record<string, any>>;
  areaAplicadaHa?: number;
  talhaoNome?: string;
}

const fmtBRL = (n: number) =>
  n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

const PRODUTOR_PALETTE = [
  '#3B82F6', '#EF4444', '#F59E0B', '#10B981',
  '#8B5CF6', '#06B6D4', '#EC4899', '#84CC16',
  '#F97316', '#14B8A6', '#6366F1', '#EAB308',
  '#22C55E', '#A855F7', '#0EA5E9', '#FB7185',
];

const esc = (value: string) =>
  value
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');

function normalizeBrPhone(raw: string): string {
  const digits = String(raw || '').replace(/\D/g, '');
  if (!digits) return '';
  if (digits.startsWith('55')) return digits;
  return `55${digits}`;
}

function formatBrPhone(raw: string): string {
  const normalized = normalizeBrPhone(raw);
  if (!normalized) return 'Não informado';

  const local = normalized.startsWith('55') ? normalized.slice(2) : normalized;
  if (local.length === 11) {
    return `(${local.slice(0, 2)}) ${local.slice(2, 7)}-${local.slice(7)}`;
  }
  if (local.length === 10) {
    return `(${local.slice(0, 2)}) ${local.slice(2, 6)}-${local.slice(6)}`;
  }
  return `+${normalized}`;
}

function buildHtml(input: ExportCotacaoPdfInput, appLogoBase64?: string): string {
  const data = (input.dataGeracao ?? new Date()).toLocaleString('pt-BR');
  const phoneRaw = String(input.consultorEmpresa?.phone || '').trim();
  const phoneBr = normalizeBrPhone(phoneRaw);
  const phoneFormatted = formatBrPhone(phoneRaw);
  const telHref = phoneBr ? `tel:+${phoneBr}` : '';
  const whatsappHref = phoneBr ? `https://wa.me/${phoneBr}` : '';

  const categoriasOrdenadas = [...input.categorias].sort((a, b) => {
    return b.somaMin - a.somaMin;
  });

  const categoriasAlfabeticas = [...input.categorias]
    .map(c => c.categoria)
    .sort((a, b) => a.localeCompare(b));
  const corPorCategoria: Record<string, string> = {};
  categoriasAlfabeticas.forEach((cat, index) => {
    corPorCategoria[cat] = PRODUTOR_PALETTE[index % PRODUTOR_PALETTE.length];
  });

  const getCatColor = (categoria: string) => corPorCategoria[categoria] || '#3B82F6';

  const comparativoCotacoes = [...(input.comparativoCotacoes ?? [])].sort((a, b) => a.totalGeral - b.totalGeral);
  const comparativoProdutos = [...(input.comparativoProdutos ?? [])];
  const hasComparativo = comparativoCotacoes.length > 1;
  const usandoTalhaoArea = !hasComparativo && Number(input.areaAplicadaHa ?? 1) > 1;
  const unidadeValor = usandoTalhaoArea ? 'R$ no talhão' : 'R$/ha';
  const menorCotacaoValor = comparativoCotacoes.length > 0
    ? Math.min(...comparativoCotacoes.map(row => Number(row.totalGeral || 0)))
    : Number(input.totalGeralMin || 0);
  const valorPrincipal = hasComparativo ? menorCotacaoValor : Number(input.totalGeralMin || 0);
  const labelPrincipal = hasComparativo ? 'Cotação menor valor (R$/ha)' : `Total da cotação (${unidadeValor})`;

  const comparativoCotacoesHtml = comparativoCotacoes.length > 1
    ? `
      <h2>Comparativo entre cotações</h2>
      <p class="sub">Custo geral por cotação (menor para maior).</p>
      <table>
        <thead>
          <tr>
            <th>Posição</th>
            <th>Cotação</th>
            <th>Total (R$/ha)</th>
          </tr>
        </thead>
        <tbody>
          ${comparativoCotacoes
            .map((row, idx) => `
              <tr>
                <td class="td-rank">#${idx + 1}</td>
                <td>${esc(row.titulo)}</td>
                <td class="td-num">R$ ${fmtBRL(row.totalGeral)}</td>
              </tr>
            `)
            .join('')}
        </tbody>
      </table>
    `
    : '';

  const comparativoProdutosHtml = comparativoProdutos.length > 0
    ? `
      <h2>Comparativo de produtos equivalentes</h2>
      <p class="sub">Preço do mesmo produto em cada cotação (menor para maior).</p>
      <table>
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Produto</th>
            <th>Preços por cotação</th>
          </tr>
        </thead>
        <tbody>
          ${comparativoProdutos
            .map((row) => {
              const precos = [...(row.precos ?? [])]
                .sort((a, b) => a.valor - b.valor)
                .map((p, idx) => `${idx + 1}. ${esc(p.titulo)}: R$ ${fmtBRL(p.valor)}`)
                .join('<br/>');

              return `
                <tr>
                  <td>${esc(row.categoria)}</td>
                  <td class="td-prod">${esc(row.produto)}</td>
                  <td>${precos || '-'}</td>
                </tr>
              `;
            })
            .join('')}
        </tbody>
      </table>
    `
    : '';

  const categoriasHtml = categoriasOrdenadas
    .map(cat => {
      const color = getCatColor(cat.categoria);

      const produtosHtml = cat.produtos
        .map(prod => {
          const valores = [...prod.opcoes].map(op => Number(op.valorHa || 0)).filter(v => Number.isFinite(v));
          const totalProduto = valores.reduce((sum, v) => sum + v, 0);
          const diffProduto = valores.length > 1 ? Math.max(...valores) - Math.min(...valores) : 0;
          return `
            <tr>
              <td class="td-prod">${esc(prod.produto)}</td>
              <td class="td-rank">${prod.opcoes.length}</td>
              <td class="td-num">R$ ${fmtBRL(totalProduto)}</td>
              <td class="td-num">${diffProduto > 0 ? `R$ ${fmtBRL(diffProduto)}` : '-'}</td>
            </tr>
          `;
        })
        .join('');

      return `
        <section class="cat-card">
          <div class="cat-head">
            <div>
              <h3>${esc(cat.categoria)}</h3>
              <p>${cat.produtos.length} produto(s)</p>
            </div>
            <div class="cat-values">
              <span>Custo da categoria: <strong>R$ ${fmtBRL(cat.somaMin)}</strong></span>
            </div>
          </div>

          <div class="bars-wrap">
            <div class="bar-row">
              <span>Custo</span>
              <div class="bar-track">
                <div class="bar-fill" style="width:100%;background:${color};"></div>
              </div>
              <span>R$ ${fmtBRL(cat.somaMin)}</span>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Produto</th>
                <th>Fornecedores</th>
                <th>Custo total (${unidadeValor})</th>
                <th>Diferença (${unidadeValor})</th>
              </tr>
            </thead>
            <tbody>${produtosHtml}</tbody>
          </table>
        </section>
      `;
    })
    .join('');

  const linhasCompletasHtml = categoriasOrdenadas
    .flatMap(cat =>
      cat.produtos.flatMap(prod => {
        // MÁGICA DOS EXTRAS: Busca extras (Estádio, Alvo, etc.) do JSON para o PDF
        const itemJson = input.excelItensJson?.find(x => String(x.produto).trim() === String(prod.produto).trim());
        const extrasTxt = itemJson 
          ? Object.entries(itemJson)
              .filter(([k]) => !['produto','fornecedor','categoria','valor_ha','unidade','dose','id','cotacao_id'].includes(k))
              .map(([k, v]) => `${k}: ${v}`)
              .join(' | ')
          : '';

        return [...prod.opcoes].map((op) => `
          <tr>
            <td>${esc(cat.categoria)}</td>
            <td class="td-prod">
              <div style="font-weight: bold;">${esc(prod.produto)}</div>
              ${extrasTxt ? `<div style="font-size: 9px; color: #666; font-weight: normal; margin-top: 3px;">${esc(extrasTxt)}</div>` : ''}
            </td>
            <td>${esc(op.fornecedor === 'N/I' ? 'Fornecedor Direto' : (op.fornecedor || '-'))}</td>
            <td>${esc(op.unidade || '-')}</td>
            <td class="td-num">${op.doseHa != null ? fmtBRL(Number(op.doseHa || 0)) : '-'}</td>
            <td class="td-num">R$ ${fmtBRL(Number(op.valorHa || 0))}</td>
          </tr>
        `);
      })
    ).join('');

  const singleCotacaoSectionsHtml = !hasComparativo
    ? `
      <h2>Consolidado por categoria</h2>
      ${categoriasHtml}

      <h2 class="break-page">Detalhamento completo dos itens</h2>
      <table>
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Produto</th>
            <th>Fornecedor</th>
            <th>Unidade</th>
            <th>Dose/ha</th>
            <th>Valor (${unidadeValor})</th>
          </tr>
        </thead>
        <tbody>
          ${linhasCompletasHtml}
        </tbody>
      </table>
    `
    : '';

  const excelRows = Array.isArray(input.excelItensJson) ? input.excelItensJson : [];
  const dynamicHeaders = (() => {
    const keys = new Set<string>();
    excelRows.forEach((row) => {
      Object.keys(row ?? {}).forEach((key) => {
        if (key && String(key).trim()) keys.add(String(key));
      });
    });

    const preferred = ['categoria', 'produto', 'fornecedor', 'valor_ha', 'dose', 'unidade'];
    const ordered: string[] = [];
    preferred.forEach((p) => {
      if (keys.has(p)) {
        ordered.push(p);
        keys.delete(p);
      }
    });
    return [...ordered, ...Array.from(keys)];
  })();

  const dynamicListHtml = (!hasComparativo && excelRows.length > 0 && dynamicHeaders.length > 0)
    ? `
      <h2 class="break-page">Lista completa extraída da planilha</h2>
      <table>
        <thead>
          <tr>
            ${dynamicHeaders.map((h) => `<th>${esc(h)}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${excelRows
            .map((row) => {
              return `
                <tr>
                  ${dynamicHeaders
                    .map((h) => {
                      const raw = row?.[h];
                      const value = raw == null ? '' : String(raw);
                      if (h === 'valor_ha' || h === 'dose') {
                        const num = Number(String(raw ?? '').replace(',', '.'));
                        return `<td class="td-num">${Number.isFinite(num) ? fmtBRL(num) : esc(value)}</td>`;
                      }
                      return `<td>${esc(value)}</td>`;
                    })
                    .join('')}
                </tr>
              `;
            })
            .join('')}
        </tbody>
      </table>
    `
    : '';

  return `
  <!doctype html>
  <html lang="pt-BR">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 20px; color: #1f2937; }
        h1 { margin: 0; font-size: 22px; }
        h2 { margin: 18px 0 8px; font-size: 15px; }
        .top-head {
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 12px;
          display: grid;
          grid-template-columns: 82px 1fr;
          gap: 12px;
          margin-bottom: 10px;
          align-items: center;
        }
        .logo-wrap {
          width: 78px;
          height: 78px;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          background: #fafafa;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        }
        .logo-wrap img { width: 100%; height: 100%; object-fit: contain; }
        .logo-fallback { font-size: 9px; color: #6b7280; text-align: center; font-weight: 700; }
        .head-lines { display: grid; grid-template-columns: 1fr; gap: 3px; }
        .head-title { font-size: 18px; font-weight: 800; margin: 0; }
        .head-sub { font-size: 11px; color: #374151; }
        .head-sub strong { color: #111827; }
        .phone-strong { color: #065f46; font-weight: 800; }
        .head-links { display: flex; gap: 8px; margin-top: 2px; flex-wrap: wrap; }
        .head-link {
          font-size: 10px;
          font-weight: 700;
          text-decoration: none;
          color: #0f766e;
          border: 1px solid #99f6e4;
          background: #f0fdfa;
          border-radius: 999px;
          padding: 3px 8px;
        }
        .sub { color: #4b5563; margin: 4px 0 16px; font-size: 12px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
        .kpi { border: 1px solid #d1d5db; border-radius: 10px; padding: 10px; background: #f9fafb; }
        .kpi .lbl { font-size: 11px; color: #6b7280; margin-bottom: 4px; }
        .kpi .val { font-size: 18px; font-weight: 700; }
        .kpi.min .val { color: #166534; }
        .kpi.max .val { color: #991b1b; }
        .kpi.eco .val { color: #1d4ed8; }
        .cat-card { border: 1px solid #dbe4db; border-radius: 12px; padding: 12px; margin: 10px 0 16px; page-break-inside: avoid; }
        .cat-head { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .cat-head h3 { margin: 0; font-size: 16px; }
        .cat-head p { margin: 2px 0 0; color: #6b7280; font-size: 12px; }
        .cat-values { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; font-size: 12px; }
        .bars-wrap { margin: 8px 0 10px; }
        .bar-row { display: grid; grid-template-columns: 50px 1fr 105px; gap: 8px; align-items: center; margin: 6px 0; font-size: 11px; }
        .bar-track { height: 10px; background: #ecf1ec; border-radius: 999px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 999px; }
        table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        th, td { border: 1px solid #e5e7eb; padding: 6px; font-size: 11px; text-align: left; }
        thead { background: #f3f4f6; }
        .td-num { text-align: right; font-variant-numeric: tabular-nums; }
        .td-prod { font-weight: 700; }
        .td-rank { text-align: center; font-variant-numeric: tabular-nums; }
        .diff-best { color: #166534; font-weight: 700; background: #ecfdf3; }
        .diff-low { color: #1d4ed8; font-weight: 700; background: #eff6ff; }
        .diff-mid { color: #92400e; font-weight: 700; background: #fffbeb; }
        .diff-high { color: #991b1b; font-weight: 700; background: #fef2f2; }
        .break-page { page-break-before: always; }
        .pdf-footer {
          margin-top: 32px;
          padding-top: 16px;
          border-top: 2px solid #e5e7eb;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 6px;
        }
        .pdf-footer img {
          width: 80px;
          height: 80px;
          object-fit: contain;
        }
        .pdf-footer-text {
          font-size: 11px;
          color: #6b7280;
          text-align: center;
        }
        .pdf-footer-brand {
          font-size: 13px;
          font-weight: 800;
          color: #111827;
        }
        .pdf-footer-slogan {
          font-size: 11px;
          font-weight: 600;
          color: #F59E0B;
          letter-spacing: 0.3px;
        }
      </style>
    </head>
    <body>
      <div class="top-head">
        <div class="logo-wrap">
          ${input.consultorEmpresa?.logoUrl
            ? `<img src="${esc(input.consultorEmpresa.logoUrl)}" alt="Logo da empresa" />`
            : `<span class="logo-fallback">LOGO<br/>EMPRESA</span>`}
        </div>
        <div class="head-lines">
          <h1 class="head-title">${esc(input.titulo || 'Relatório Comercial da Cotação')}</h1>
          <div class="head-sub"><strong>Fazenda:</strong> ${esc(input.fazendaNome || 'Não informada')}</div>
          ${input.fazendaNome ? `<div class="head-sub"><strong>Produtor:</strong> ${esc(input.produtorNome || 'Não informado')}</div>` : ''}
          ${input.fazendaLocalizacao ? `<div class="head-sub"><strong>Cidade/UF:</strong> ${esc(input.fazendaLocalizacao)}</div>` : ''}
          <div class="head-sub"><strong>Empresa:</strong> ${esc(input.consultorEmpresa?.companyName || 'Não informada')}</div>
          <div class="head-sub"><strong>Consultor:</strong> ${esc(input.consultorEmpresa?.consultorNome || 'Não informado')}</div>
          <div class="head-sub"><strong>CNPJ:</strong> ${esc(input.consultorEmpresa?.cnpj || 'Não informado')}</div>
          <div class="head-sub"><strong>Telefone do consultor:</strong> <span class="phone-strong">${esc(phoneFormatted)}</span></div>
          ${phoneBr ? `
            <div class="head-links">
              <a class="head-link" href="${esc(telHref)}">Ligar</a>
              <a class="head-link" href="${esc(whatsappHref)}">WhatsApp</a>
            </div>
          ` : ''}
        </div>
      </div>
      <p class="sub">Gerado em ${data}</p>
      ${usandoTalhaoArea ? `<p class="sub">Área aplicada: ${esc(input.talhaoNome || 'Talhão selecionado')} · ${fmtBRL(Number(input.areaAplicadaHa || 0))} ha</p>` : ''}

      <div class="kpi-grid">
        <div class="kpi min">
          <div class="lbl">${labelPrincipal}</div>
          <div class="val">R$ ${fmtBRL(valorPrincipal)}</div>
        </div>
      </div>

      ${comparativoCotacoesHtml}
      ${comparativoProdutosHtml}
      ${singleCotacaoSectionsHtml}
      ${dynamicListHtml}

      <div class="pdf-footer">
        ${appLogoBase64
          ? `<img src="data:image/png;base64,${appLogoBase64}" alt="AgroCota" />`
          : ''}
        <div class="pdf-footer-slogan">Cota&ccedil;&otilde;es de insumos para o campo</div>
        <div class="pdf-footer-text">Relat&oacute;rio gerado pelo aplicativo AgroCota</div>
      </div>

    </body>
  </html>
  `;
}

export async function exportarCotacaoPdf(input: ExportCotacaoPdfInput): Promise<void> {
  try {
    let appLogoBase64: string | undefined;
    try {
      const asset = Asset.fromModule(require('../../assets/icon.png'));
      await asset.downloadAsync();
      if (asset.localUri) {
        appLogoBase64 = await FileSystem.readAsStringAsync(asset.localUri, {
          encoding: FileSystem.EncodingType.Base64,
        });
      }
    } catch (_) {
      // logo carregamento opcional — continua sem
    }
    const html = buildHtml(input, appLogoBase64);
    const { uri } = await Print.printToFileAsync({ html });

    const safeTitle = (input.titulo || 'cotacao')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-zA-Z0-9_-]+/g, '_')
      .replace(/^_+|_+$/g, '')
      .slice(0, 40);

    const fileName = `cotacao_${safeTitle || 'relatorio'}_${Date.now()}.pdf`;
    const destino = `${FileSystem.cacheDirectory}${fileName}`;
    await FileSystem.copyAsync({ from: uri, to: destino });

    const canShare = await Sharing.isAvailableAsync();
    if (!canShare) {
      Alert.alert('PDF gerado', 'Arquivo criado, mas compartilhamento não está disponível neste dispositivo.');
      return;
    }

    await Sharing.shareAsync(destino, {
      mimeType: 'application/pdf',
      UTI: 'com.adobe.pdf',
      dialogTitle: 'Exportar relatório da cotação (PDF)',
    });
  } catch (err: any) {
    Alert.alert('Erro ao exportar PDF', err?.message ?? 'Não foi possível gerar o PDF.');
  }
}
