<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agrocota - Comparativo de Decisão</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #040404;
      --surface: #0e0e0e;
      --surface2: #161616;
      --border: #1e1e1e;
      --border2: #2a2a2a;
      --primary: #22c55e;
      --text: #f0f0f0;
      --text-mid: #666;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    /* TOP BAR IGUAL INDEX */
    .top-bar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(4,4,4,.88);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      padding: 13px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-size: .68rem; font-weight: 900; letter-spacing: .2em; color: var(--primary); text-transform: uppercase; }
    .status-pill {
      font-size: .58rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase;
      padding: 4px 10px; border-radius: 100px;
      border: 1px solid var(--border2); color: var(--text-mid);
    }

    .page { max-width: 620px; margin: 0 auto; padding: 28px 16px 150px; }

    /* META BLOCK IGUAL INDEX */
    .meta-block { margin-bottom: 36px; }
    .meta-title { font-size: 1.5rem; font-weight: 900; line-height: 1.2; letter-spacing: -.02em; margin-bottom: 18px; }
    .meta-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 1px; background: var(--border);
      border: 1px solid var(--border); border-radius: 14px; overflow: hidden;
    }
    .meta-cell { background: var(--surface); padding: 12px 14px; }
    .meta-key { font-size: .6rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 3px; }
    .meta-val { font-size: .88rem; font-weight: 600; color: var(--text); }

    /* SECTIONS */
    .section-hd { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; margin-top: 36px; }
    .section-hd h2 { font-size: .62rem; font-weight: 800; letter-spacing: .14em; text-transform: uppercase; color: var(--text-mid); white-space: nowrap; }
    .section-line { flex: 1; height: 1px; background: var(--border); }

    /* CHART WRAP */
    .chart-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px 20px;
      display: flex; flex-direction: column; align-items: center;
    }

    /* OPTION CARDS / PRODUTOS */
    .option-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px; margin-bottom: 10px;
      cursor: pointer; transition: 0.2s;
    }
    .option-card.selected { border-color: var(--primary); background: #021a09; }
    .option-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .option-title { font-size: .95rem; font-weight: 900; color: var(--text); }
    .option-price { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--primary); }
    
    .prod-pill-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .prod-pill {
      font-size: .62rem; font-weight: 600; padding: 4px 8px;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 6px; color: var(--text-mid);
    }

    /* FOOTER */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      padding: 14px 16px calc(20px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, var(--bg) 80%, transparent);
    }
    .btn-confirm {
      max-width: 588px; margin: 0 auto; display: block;
      width: 100%; background: var(--primary); color: #000; border: none;
      padding: 16px; border-radius: 15px; font-weight: 900;
      font-size: .75rem; letter-spacing: .1em; text-transform: uppercase;
      cursor: pointer; box-shadow: 0 0 40px rgba(34,197,94,.15);
    }
  </style>
</head>
<body>

<div class="top-bar">
  <span class="brand">Agrocota</span>
  <span class="status-pill">Painel Comparativo</span>
</div>

<main class="page">
  <div class="meta-block">
    <h1 class="meta-title" id="page-title">Comparativo de Safra</h1>
    <div class="meta-grid" id="meta-grid">
      </div>
  </div>

  <div class="section-hd">
    <h2>Comparativo de Investimento</h2>
    <div class="section-line"></div>
  </div>

  <div class="chart-wrap">
    <canvas id="barChart"></canvas>
  </div>

  <div class="section-hd">
    <h2>Selecione a Proposta</h2>
    <div class="section-line"></div>
  </div>

  <div id="option-list"></div>
</main>

<div class="sticky-footer">
  <button class="btn-confirm" onclick="confirmarEscolha()">Aprovar Proposta Selecionada</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "seu-projeto.firebaseapp.com",
    projectId: "seu-projeto",
    storageBucket: "seu-projeto.appspot.com",
    messagingSenderId: "000000000000",
    appId: "1:000000000000:web:000000000"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const dataEncoded = params.get('data');
  const cotacaoId = params.get('id');
  
  const payload = dataEncoded ? JSON.parse(atob(dataEncoded)) : { cotacoes: [], produtos: [], meta: {} };
  let selecionado = null;

  // Renderiza Cabeçalho IDÊNTICO ao Index
  const grid = document.getElementById('meta-grid');
  const addMeta = (k, v) => {
    grid.innerHTML += `<div class="meta-cell"><div class="meta-key">${k}</div><div class="meta-val">${v || '---'}</div></div>`;
  };

  document.getElementById('page-title').textContent = payload.meta?.titulo || 'Comparativo';
  addMeta('Fazenda', payload.meta?.fazenda);
  addMeta('Produtor', payload.meta?.produtor);
  addMeta('Consultor', payload.meta?.consultor);
  addMeta('Área', payload.meta?.area ? payload.meta.area + ' ha' : '---');

  // Gráfico de Barras Horizontais
  new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: payload.cotacoes.map(c => c.titulo),
      datasets: [{
        data: payload.cotacoes.map(c => c.total),
        backgroundColor: '#22c55e',
        borderRadius: 8,
        barThickness: 30
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#1e1e1e' }, ticks: { color: '#666', font: { family: 'JetBrains Mono', size: 10 } } },
        y: { ticks: { color: '#f0f0f0', font: { weight: '800' } } }
      }
    }
  });

  // Renderiza Cards com Detalhes dos Produtos
  const container = document.getElementById('option-list');
  payload.cotacoes.forEach((c, idx) => {
    const card = document.createElement('div');
    card.className = 'option-card';
    card.innerHTML = `
      <div class="option-header">
        <div class="option-title">${c.titulo}</div>
        <div class="option-price">R$ ${c.total.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
      </div>
      <div class="prod-pill-list">
        ${payload.produtos.map(p => `<span class="prod-pill">${p.nome}</span>`).join('')}
      </div>
    `;
    card.onclick = () => {
      document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
      card.classList.add('selected');
      selecionado = c;
    };
    container.appendChild(card);
  });

  window.confirmarEscolha = async () => {
    if(!selecionado) return alert("Selecione uma proposta primeiro.");
    if(confirm(`Confirmar aceite da proposta: ${selecionado.titulo}?`)) {
        try {
            await updateDoc(doc(db, "cotacoes", cotacaoId), {
                status: "Aprovada",
                fornecedorVencedor: selecionado.titulo,
                valorAprovado: selecionado.total,
                dataAceite: new Date().toISOString()
            });
            alert("✅ Sucesso! O consultor foi notificado.");
        } catch(e) { alert("Erro ao gravar no banco de dados."); }
    }
  };
</script>
</body>
</html>
