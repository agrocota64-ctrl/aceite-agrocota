<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agrocota - Comparativo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:          #040404;
      --surface:     #0e0e0e;
      --surface2:    #161616;
      --border:      #1e1e1e;
      --border2:     #2a2a2a;
      --primary:     #22c55e;
      --primary-dim: #021a09;
      --text:        #f0f0f0;
      --text-mid:    #666;
      --text-low:    #333;
      --red:         #ef4444;
      --amber:       #f59e0b;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }

    /* STATES */
    #state-loading, #state-error { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100svh; gap: 16px; }
    #state-error { padding: 32px; text-align: center; }
    .loader { width: 32px; height: 32px; border: 2px solid var(--border2); border-top-color: var(--primary); border-radius: 50%; animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .state-label { font-size: .7rem; font-weight: 700; letter-spacing: .1em; color: var(--text-mid); text-transform: uppercase; }
    .err-title { font-size: .95rem; font-weight: 800; color: var(--red); }
    .err-body  { font-size: .78rem; color: var(--text-mid); margin-top: 6px; }

    /* TOP BAR */
    .top-bar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(4,4,4,.92);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      padding: 13px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-size: .68rem; font-weight: 900; letter-spacing: .2em; color: var(--primary); text-transform: uppercase; }
    .status-pill { font-size: .58rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase; padding: 4px 10px; border-radius: 100px; border: 1px solid var(--amber); color: var(--amber); }
    .status-pill.aprovado { border-color: var(--primary); color: var(--primary); }

    /* PAGE */
    .page { max-width: 620px; margin: 0 auto; padding: 28px 16px 140px; }

    /* META */
    .meta-block { margin-bottom: 32px; }
    .meta-title { font-size: 1.5rem; font-weight: 900; line-height: 1.2; letter-spacing: -.02em; margin-bottom: 16px; }
    .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    @media (max-width: 380px) { .meta-grid { grid-template-columns: 1fr; } }
    .meta-cell { background: var(--surface); padding: 12px 14px; }
    .meta-key { font-size: .6rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 3px; }
    .meta-val { font-size: .88rem; font-weight: 600; color: var(--text); }

    /* SECTION HEADER */
    .section-hd { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; margin-top: 36px; }
    .section-hd h2 { font-size: .62rem; font-weight: 800; letter-spacing: .14em; text-transform: uppercase; color: var(--text-mid); white-space: nowrap; }
    .section-line { flex: 1; height: 1px; background: var(--border); }

    /* CHART CARD */
    .chart-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px 20px;
    }

    /* DONUT */
    .donut-wrap { display: flex; flex-direction: column; align-items: center; gap: 24px; }
    .donut-canvas-wrap { position: relative; width: 190px; height: 190px; flex-shrink: 0; }
    canvas#donut { width: 190px !important; height: 190px !important; }
    .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; pointer-events: none; }
    .donut-center-label { font-size: .52rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .donut-center-value { font-family: 'JetBrains Mono', monospace; font-size: .82rem; font-weight: 700; color: var(--text); display: block; line-height: 1.4; margin-top: 1px; }

    /* DONUT LEGEND — discreta, horizontal em chips */
    .donut-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; width: 100%; }
    .donut-chip {
      display: flex; align-items: center; gap: 6px;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 100px; padding: 5px 10px;
    }
    .donut-chip-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .donut-chip-name { font-size: .68rem; font-weight: 700; color: var(--text-mid); }
    .donut-chip-pct  { font-family: 'JetBrains Mono', monospace; font-size: .68rem; font-weight: 700; }

    /* DIFERENÇA entre cotações */
    .diff-badge {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 12px; padding: 10px 16px; margin-top: 4px;
    }
    .diff-label { font-size: .62rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--text-mid); }
    .diff-value { font-family: 'JetBrains Mono', monospace; font-size: .9rem; font-weight: 900; color: var(--primary); }

    /* BAR CHART — produto com nome + barra + % + valor */
    .bar-list { display: flex; flex-direction: column; gap: 10px; }
    .bar-row { display: flex; align-items: center; gap: 10px; }
    .bar-label { font-size: .75rem; font-weight: 700; color: var(--text); width: 110px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .bar-track { flex: 1; height: 8px; background: var(--border2); border-radius: 99px; overflow: hidden; }
    .bar-fill  { height: 100%; border-radius: 99px; transition: width .6s cubic-bezier(.4,0,.2,1); }
    .bar-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; min-width: 110px; justify-content: flex-end; }
    .bar-pct   { font-size: .62rem; font-weight: 700; color: var(--text-mid); min-width: 32px; text-align: right; }
    .bar-val   { font-family: 'JetBrains Mono', monospace; font-size: .72rem; font-weight: 700; min-width: 72px; text-align: right; }

    /* SELEÇÃO — cards compactos */
    .select-list { display: flex; flex-direction: column; gap: 8px; }
    .select-card {
      display: flex; align-items: center; gap: 14px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px;
      cursor: pointer; transition: border-color .18s, background .18s, transform .1s;
      -webkit-tap-highlight-color: transparent; user-select: none;
    }
    .select-card:active { transform: scale(.98); }
    .select-card.active { border-color: var(--primary); background: var(--primary-dim); }
    .select-card.active .select-radio { background: var(--primary); border-color: var(--primary); }
    .select-card.active .select-radio::after { opacity: 1; }
    .select-radio {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid var(--border2); flex-shrink: 0;
      position: relative; transition: .18s;
    }
    .select-radio::after {
      content: ''; position: absolute; top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      width: 7px; height: 7px; border-radius: 50%;
      background: #000; opacity: 0; transition: opacity .18s;
    }
    .select-info { flex: 1; min-width: 0; }
    .select-title { font-size: .88rem; font-weight: 800; color: var(--text); }
    .select-badge { font-size: .55rem; font-weight: 900; letter-spacing: .08em; text-transform: uppercase; padding: 2px 7px; border-radius: 6px; background: var(--primary); color: #000; margin-left: 7px; vertical-align: middle; }
    .select-price { font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 900; flex-shrink: 0; }

    /* APPROVED */
    .approved-card { background: var(--primary-dim); border: 1px solid var(--primary); border-radius: 18px; padding: 22px; text-align: center; margin-bottom: 28px; }
    .approved-title { font-size: .95rem; font-weight: 900; color: var(--primary); margin-bottom: 5px; }
    .approved-sub   { font-size: .75rem; color: var(--text-mid); }
    .approved-ts    { font-family: 'JetBrains Mono', monospace; font-size: .68rem; color: var(--primary); margin-top: 8px; }

    /* STICKY FOOTER */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      padding: 14px 16px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, var(--bg) 70%, transparent);
    }
    .footer-inner { max-width: 620px; margin: 0 auto; }
    .footer-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; padding: 0 2px; }
    .footer-label { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .footer-selected { font-size: .8rem; font-weight: 700; color: var(--text); }
    .footer-total { font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 700; color: var(--text); }
    .btn-confirm {
      width: 100%; background: var(--primary); color: #000; border: none;
      padding: 16px; border-radius: 15px; font-family: 'Inter', sans-serif; font-size: .75rem; font-weight: 900;
      letter-spacing: .1em; text-transform: uppercase; cursor: pointer;
      transition: opacity .18s, transform .12s; box-shadow: 0 0 40px rgba(34,197,94,.12);
    }
    .btn-confirm:active { transform: scale(.97); }
    .btn-confirm:disabled { opacity: .3; cursor: not-allowed; box-shadow: none; }

    /* MODAL */
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: flex-end; justify-content: center; padding: 16px;
      opacity: 0; pointer-events: none; transition: opacity .25s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 24px; padding: 26px 22px; width: 100%; max-width: 600px;
      transform: translateY(24px); transition: transform .3s cubic-bezier(.4,0,.2,1);
    }
    .modal-backdrop.open .modal { transform: translateY(0); }
    .modal-title { font-size: .95rem; font-weight: 900; margin-bottom: 5px; }
    .modal-sub   { font-size: .75rem; color: var(--text-mid); margin-bottom: 20px; }
    .modal-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--border); }
    .modal-row:last-child { border-bottom: none; }
    .modal-row-name  { font-size: .78rem; font-weight: 600; }
    .modal-row-price { font-family: 'JetBrains Mono', monospace; font-size: .76rem; font-weight: 700; color: var(--primary); }
    .modal-total { display: flex; justify-content: space-between; align-items: center; padding-top: 14px; margin-top: 4px; border-top: 1px solid var(--border2); }
    .modal-total-label { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .modal-total-val   { font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 900; }
    .modal-summary-box { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 4px 14px; margin-bottom: 16px; max-height: 220px; overflow-y: auto; }
    .modal-actions { display: flex; gap: 10px; margin-top: 16px; }
    .btn-cancel { flex: 1; background: transparent; border: 1px solid var(--border2); color: var(--text-mid); padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif; font-size: .72rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; cursor: pointer; }
    .btn-ok { flex: 2; background: var(--primary); color: #000; border: none; padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif; font-size: .72rem; font-weight: 900; letter-spacing: .1em; text-transform: uppercase; cursor: pointer; }
    .btn-ok:disabled { opacity: .5; cursor: not-allowed; }

    .page-footer { text-align: center; padding: 12px 16px; font-size: .6rem; color: var(--text-low); letter-spacing: .06em; text-transform: uppercase; }
  </style>
</head>
<body>

<div id="state-loading">
  <div class="loader"></div>
  <span class="state-label">Carregando comparativo</span>
</div>
<div id="state-error" style="display:none">
  <span class="err-title" id="err-title">Dados não encontrados</span>
  <p class="err-body" id="err-body">Solicite um novo link ao consultor responsável.</p>
</div>

<div id="app" style="display:none">
  <div class="top-bar">
    <span class="brand">Agrocota</span>
    <span class="status-pill" id="status-pill">Aguardando aceite</span>
  </div>

  <main class="page">

    <!-- META -->
    <div class="meta-block">
      <h1 class="meta-title" id="meta-titulo">Comparativo de Cotação</h1>
      <div class="meta-grid" id="meta-grid"></div>
    </div>

    <!-- BANNER APROVADO -->
    <div class="approved-card" id="approved-banner" style="display:none">
      <div class="approved-title">Aceite Registrado</div>
      <div class="approved-sub">Seu consultor foi notificado. Obrigado pela confirmação.</div>
      <div class="approved-ts" id="approved-ts"></div>
    </div>

    <!-- GRÁFICO 1: DONUT — cotações entre si -->
    <div class="section-hd">
      <h2>Comparativo de Investimento</h2>
      <div class="section-line"></div>
    </div>
    <div class="chart-card">
      <div class="donut-wrap">
        <div class="donut-canvas-wrap">
          <canvas id="donut" width="190" height="190"></canvas>
          <div class="donut-center">
            <span class="donut-center-label">Diferença</span>
            <span class="donut-center-value" id="donut-diff">—</span>
          </div>
        </div>
        <div class="donut-legend" id="donut-legend"></div>
        <div class="diff-badge" id="diff-badge" style="display:none">
          <span class="diff-label">Economia potencial</span>
          <span class="diff-value" id="diff-value">—</span>
        </div>
      </div>
    </div>

    <!-- GRÁFICO 2: BARRAS — produtos -->
    <div class="section-hd" style="margin-top:36px">
      <h2>Comparativo por Produto</h2>
      <div class="section-line"></div>
    </div>
    <div class="chart-card">
      <div class="bar-list" id="bar-list"></div>
    </div>

    <!-- SELEÇÃO -->
    <div class="section-hd" style="margin-top:36px">
      <h2>Selecione a Proposta</h2>
      <div class="section-line"></div>
    </div>
    <div class="select-list" id="select-list"></div>

  </main>

  <div class="sticky-footer" id="sticky-footer">
    <div class="footer-inner">
      <div class="footer-row">
        <span class="footer-label">Proposta</span>
        <span class="footer-selected" id="footer-selected">Nenhuma selecionada</span>
      </div>
      <button class="btn-confirm" id="btn-aceite" onclick="abrirModal()" disabled>Confirmar Aceite</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modal-backdrop" onclick="fecharModalFora(event)">
  <div class="modal">
    <div class="modal-title">Confirmar Aceite</div>
    <div class="modal-sub">Revise a proposta antes de confirmar. Esta ação será registrada.</div>
    <div class="modal-summary-box" id="modal-rows"></div>
    <div class="modal-total">
      <span class="modal-total-label">Total</span>
      <span class="modal-total-val" id="modal-total">—</span>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModal()">Voltar</button>
      <button class="btn-ok" id="btn-ok" onclick="confirmarAceite()">Confirmar Aceite</button>
    </div>
  </div>
</div>

<footer class="page-footer">Agrocota 2025 &mdash; Plataforma de Decisão Agrícola</footer>

<script>
  const SUPABASE_URL  = 'https://fafjknchnibdflpqyssf.supabase.co';
  const SUPABASE_ANON = 'sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r';

  /* paleta de cotações — verde primeiro (menor), depois azul, laranja... */
  const COT_PALETTE = ['#22c55e','#3B82F6','#F59E0B','#8B5CF6','#EF4444','#06B6D4','#EC4899','#84CC16'];

  const fmtBRL      = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtDate     = s => !s ? '—' : new Date(s).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fmtDateTime = s => !s ? '—' : new Date(s).toLocaleString('pt-BR');
  const esc         = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  async function rpc(fn, body) {
    const r = await fetch(SUPABASE_URL + '/rest/v1/rpc/' + fn, {
      method: 'POST',
      headers: { apikey: SUPABASE_ANON, Authorization: 'Bearer ' + SUPABASE_ANON, 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!r.ok) throw new Error('RPC error: ' + fn);
    return r.json();
  }

  function showError(msg, sub) {
    document.getElementById('state-loading').style.display = 'none';
    document.getElementById('state-error').style.display   = 'flex';
    if (msg) document.getElementById('err-title').textContent = msg;
    if (sub) document.getElementById('err-body').textContent  = sub;
  }

  function addMeta(key, val) {
    const g = document.getElementById('meta-grid');
    const c = document.createElement('div');
    c.className = 'meta-cell';
    c.innerHTML = '<div class="meta-key">' + key + '</div><div class="meta-val">' + esc(String(val||'—')) + '</div>';
    g.appendChild(c);
  }

  let cotacao     = null;
  let payload     = null;
  let selecionado = null;
  let approved    = false;
  let donutChart  = null;

  /* ordena cotações do menor para o maior — verde = mais barata */
  function cotacoesOrdenadas() {
    return [...payload.cotacoes].sort((a,b) => a.total - b.total);
  }

  /* ── DONUT: cada cotação = uma fatia, mostra diferença no centro ── */
  function buildDonut() {
    const sorted = cotacoesOrdenadas();
    const labels = sorted.map(c => c.titulo);
    const values = sorted.map(c => c.total);
    const colors = sorted.map((_, i) => COT_PALETTE[i % COT_PALETTE.length]);
    const total  = values.reduce((a,b) => a+b, 0);
    const min    = values[0] || 0;
    const max    = values[values.length-1] || 0;
    const diff   = max - min;

    /* centro: diferença entre maior e menor */
    const diffEl = document.getElementById('donut-diff');
    diffEl.textContent = diff > 0 ? 'R$ ' + fmtBRL(diff) : '—';
    diffEl.style.color = diff > 0 ? '#22c55e' : 'var(--text-mid)';

    /* badge economia */
    if (diff > 0) {
      document.getElementById('diff-badge').style.display = 'flex';
      document.getElementById('diff-value').textContent   = 'R$ ' + fmtBRL(diff);
    }

    const donutEl = document.getElementById('donut');
    donutEl.width  = 190;
    donutEl.height = 190;
    const ctx = donutEl.getContext('2d');
    if (donutChart) donutChart.destroy();
    donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data: values, backgroundColor: colors, borderColor: '#040404', borderWidth: 3, hoverOffset: 6 }]
      },
      options: {
        cutout: '78%',
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: c => ' ' + c.label + ': R$ ' + fmtBRL(c.parsed) } }
        },
        animation: { duration: 700, easing: 'easeInOutQuart' },
      }
    });

    /* legenda discreta em chips */
    const el = document.getElementById('donut-legend');
    el.innerHTML = '';
    sorted.forEach((c, i) => {
      const pct = total > 0 ? (c.total / total * 100).toFixed(1) : '0.0';
      const chip = document.createElement('div');
      chip.className = 'donut-chip';
      chip.innerHTML =
        '<div class="donut-chip-dot" style="background:' + colors[i] + '"></div>'
        + '<span class="donut-chip-name">' + esc(c.titulo) + '</span>'
        + '<span class="donut-chip-pct" style="color:' + colors[i] + '">' + pct + '%</span>';
      el.appendChild(chip);
    });
  }

  /* ── BARRAS: produtos agrupados por categoria, com P.A. e Fonte ── */
  function buildBars() {
    const container = document.getElementById('bar-list');
    container.innerHTML = '';
    const produtos  = payload.produtos || [];
    const sorted    = cotacoesOrdenadas();

    /* Para cada produto, os precos estão na MESMA ORDEM que payload.cotacoes (índice direto).
       Mapeamos de payload.cotacoes[i].titulo → sorted index para a cor correta. */
    const titToSortedIdx = {};
    sorted.forEach((c, i) => { titToSortedIdx[c.titulo] = i; });

    /* Agrupa produtos por categoria */
    const catGroups = {};
    produtos.forEach(prod => {
      const cat = prod.categoria || 'Insumo';
      if (!catGroups[cat]) catGroups[cat] = [];
      catGroups[cat].push(prod);
    });

    const catNames = Object.keys(catGroups).sort();
    catNames.forEach((catNome, catIdx) => {
      /* Cabeçalho da categoria */
      const catHd = document.createElement('div');
      catHd.style.cssText = (catIdx > 0 ? 'margin-top:28px;' : '') +
        'font-size:.6rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;' +
        'color:var(--text-mid);padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:12px;';
      catHd.textContent = catNome;
      container.appendChild(catHd);

      catGroups[catNome].forEach((prod, pIdx) => {
        /* entries: [{titulo, valor, color}] — usa índice direto de payload.cotacoes */
        const entries = payload.cotacoes.map((cot, i) => {
          const val = (prod.precos && prod.precos[i] != null) ? Number(prod.precos[i]) : 0;
          const si  = titToSortedIdx[cot.titulo] ?? i;
          return { titulo: cot.titulo, valor: val, color: COT_PALETTE[si % COT_PALETTE.length] };
        }).filter(e => e.valor > 0);

        if (!entries.length) return;
        const maxVal = Math.max(...entries.map(e => e.valor));

        /* bloco do produto */
        const prodWrap = document.createElement('div');
        prodWrap.style.cssText = (pIdx > 0 ? 'margin-top:18px;' : '') + 'padding-bottom:14px;border-bottom:1px solid var(--border);';

        /* nome */
        const title = document.createElement('div');
        title.style.cssText = 'font-size:.8rem;font-weight:800;color:var(--text);margin-bottom:3px;';
        title.textContent = prod.nome;
        prodWrap.appendChild(title);

        /* P.A. */
        if (prod.principio_ativo) {
          const paEl = document.createElement('div');
          paEl.style.cssText = 'font-size:.65rem;font-weight:700;color:#4ade80;margin-bottom:1px;';
          paEl.textContent = 'P.A.: ' + prod.principio_ativo;
          prodWrap.appendChild(paEl);
        }
        /* Fonte */
        if (prod.fonte) {
          const fonteEl = document.createElement('div');
          fonteEl.style.cssText = 'font-size:.65rem;font-weight:600;color:#60a5fa;margin-bottom:6px;';
          fonteEl.textContent = 'Fonte: ' + prod.fonte;
          prodWrap.appendChild(fonteEl);
        }
        if (!prod.principio_ativo && !prod.fonte) {
          prodWrap.style.marginBottom = '4px';
        }

        entries.forEach(e => {
          const pct = maxVal > 0 ? (e.valor / maxVal * 100) : 0;
          const row = document.createElement('div');
          row.className = 'bar-row';
          row.innerHTML =
            '<div class="bar-label">' + esc(e.titulo) + '</div>'
            + '<div class="bar-track"><div class="bar-fill" style="width:' + Math.max(pct,3).toFixed(1) + '%;background:' + e.color + '"></div></div>'
            + '<div class="bar-right">'
              + '<span class="bar-pct" style="color:' + e.color + '">' + pct.toFixed(0) + '%</span>'
              + '<span class="bar-val" style="color:' + e.color + '">R$ ' + fmtBRL(e.valor) + '</span>'
            + '</div>';
          prodWrap.appendChild(row);
        });
        container.appendChild(prodWrap);
      });
    });

    /* Remove borda inferior do último item */
    const lastWrap = container.querySelector('div[style*="border-bottom"]:last-of-type');
    if (lastWrap) lastWrap.style.borderBottom = 'none';
  }

  /* ── SELEÇÃO — cards compactos com radio ── */
  function renderSelecao() {
    const container = document.getElementById('select-list');
    container.innerHTML = '';
    const sorted  = cotacoesOrdenadas();
    const minTot  = sorted[0]?.total || 0;

    sorted.forEach((c, i) => {
      const color   = COT_PALETTE[i % COT_PALETTE.length];
      const isMenor = c.total === minTot;
      const origIdx = payload.cotacoes.indexOf(c);

      const card = document.createElement('div');
      card.className = 'select-card';
      card.innerHTML =
        '<div class="select-radio"></div>'
        + '<div class="select-info">'
          + '<span class="select-title">' + esc(c.titulo) + '</span>'
          + (isMenor ? '<span class="select-badge">Menor</span>' : '')
        + '</div>'
        + '<div class="select-price" style="color:' + color + '">R$ ' + fmtBRL(c.total) + '</div>';

      card.onclick = () => {
        if (approved) return;
        document.querySelectorAll('.select-card').forEach(el => el.classList.remove('active'));
        card.classList.add('active');
        selecionado = { cotacao: c, idx: origIdx };
        document.getElementById('footer-selected').textContent = c.titulo;
        document.getElementById('btn-aceite').disabled = false;
      };
      container.appendChild(card);
    });
  }

  /* ── MODAL ── */
  function abrirModal() {
    if (!selecionado) return;
    const c   = selecionado.cotacao;
    const ci  = selecionado.idx;
    const el  = document.getElementById('modal-rows');
    el.innerHTML = '';
    (payload.produtos || []).forEach(p => {
      const val = p.precos && p.precos[ci] != null ? Number(p.precos[ci]) : 0;
      const row = document.createElement('div');
      row.className = 'modal-row';
      row.innerHTML =
        '<span class="modal-row-name">' + esc(p.nome) + '</span>'
        + '<span class="modal-row-price">R$ ' + fmtBRL(val) + '</span>';
      el.appendChild(row);
    });
    document.getElementById('modal-total').textContent = 'R$ ' + fmtBRL(c.total);
    document.getElementById('modal-backdrop').classList.add('open');
  }
  function fecharModal() { document.getElementById('modal-backdrop').classList.remove('open'); }
  function fecharModalFora(e) { if (e.target === document.getElementById('modal-backdrop')) fecharModal(); }

  async function confirmarAceite() {
    if (!selecionado) return;
    const btn = document.getElementById('btn-ok');
    btn.disabled = true; btn.textContent = 'Registrando...';
    try {
      await rpc('registrar_aceite_cotacao', {
        p_cotacao_id: cotacao.id,
        p_itens:      [],
        p_total_ha:   selecionado.cotacao.total,
        p_user_agent: navigator.userAgent,
      });
      fecharModal();
      approved = true;
      document.getElementById('status-pill').textContent = 'Aceite registrado';
      document.getElementById('status-pill').className   = 'status-pill aprovado';
      document.querySelector('#approved-banner .approved-title').textContent = 'Aceite Registrado';
      document.getElementById('approved-banner').style.display = 'block';
      document.getElementById('approved-ts').textContent = 'Registrado em ' + fmtDateTime(new Date().toISOString());
      document.getElementById('sticky-footer').style.display = 'none';
    } catch(e) {
      alert('Erro ao registrar o aceite. Tente novamente.');
    } finally {
      btn.disabled = false; btn.textContent = 'Confirmar Aceite';
    }
  }

  /* ── MAIN ── */
  async function main() {
    const params      = new URLSearchParams(window.location.search);
    const cotacaoId   = params.get('id');
    const dataEncoded = params.get('data');

    if (!cotacaoId) { showError('Link inválido', 'Parâmetro "id" não encontrado na URL.'); return; }
    if (!dataEncoded) { showError('Dados não encontrados', 'Parâmetro "data" não encontrado na URL.'); return; }

    try {
      payload = JSON.parse(decodeURIComponent(escape(atob(dataEncoded))));
    } catch(e) {
      showError('Erro ao decodificar', 'Link corrompido. Solicite um novo ao consultor.'); return;
    }

    if (!payload.cotacoes || payload.cotacoes.length < 2) {
      showError('Comparativo inválido', 'São necessárias pelo menos 2 cotações.'); return;
    }

    try {
      /* busca meta da cotação via REST */
      const rows = await fetch(
        SUPABASE_URL + '/rest/v1/cotacoes?id=eq.' + cotacaoId + '&select=*&limit=1',
        { headers: { apikey: SUPABASE_ANON, Authorization: 'Bearer ' + SUPABASE_ANON } }
      ).then(r => r.json());

      if (!rows || !rows[0]) { showError('Cotação não encontrada', 'Verifique o link ou solicite um novo ao consultor.'); return; }
      cotacao = rows[0];

      /* consultor */
      let consultorNome = '—';
      try {
        const p = await rpc('get_profile_name', { p_id: cotacao.consultor_id });
        if (p && p[0]) consultorNome = p[0].full_name || '—';
      } catch(_) {}

      /* fazenda */
      let fazendaNome = '—';
      if (cotacao.fazenda_id) {
        try {
          const f = await rpc('get_fazenda_by_id', { p_id: cotacao.fazenda_id });
          if (f && f[0]) fazendaNome = f[0].nome || '—';
        } catch(_) {}
      }

      /* área */
      const areaManual = Number(cotacao?.area_ha || 0);
      const areaTalhao = Number(cotacao?.talhao_area_ha || 0);
      const areaFinal  = areaManual > 0 ? areaManual : (areaTalhao > 0 ? areaTalhao : 0);

      /* preenche meta */
      document.title = (cotacao.titulo || 'Comparativo') + ' — Agrocota';
      document.getElementById('meta-titulo').textContent = cotacao.titulo || 'Comparativo de Cotação';
      addMeta('Fazenda',   fazendaNome);
      addMeta('Área',      areaFinal > 0 ? fmtBRL(areaFinal) + ' ha' : '—');
      addMeta('Data',      fmtDate(cotacao.created_at));
      addMeta('Consultor', consultorNome);

      /* status */
      const aceiteEm = cotacao.aceite_em || cotacao.approved_at;
      if (cotacao.status === 'aprovada' || cotacao.status === 'aprovado' || aceiteEm) {
        approved = true;
        document.getElementById('status-pill').textContent = 'Aceite registrado';
        document.getElementById('status-pill').className   = 'status-pill aprovado';
        document.getElementById('approved-banner').style.display = 'block';
        document.getElementById('approved-ts').textContent = 'Registrado em ' + fmtDateTime(aceiteEm);
        document.getElementById('sticky-footer').style.display = 'none';
      }

      /* renderiza */
      buildDonut();
      buildBars();
      renderSelecao();

      document.getElementById('state-loading').style.display = 'none';
      document.getElementById('app').style.display           = 'block';

    } catch(e) {
      showError('Erro ao carregar', 'Tente novamente ou solicite um novo link ao consultor.');
    }
  }

  main();
</script>
</body>
</html>
