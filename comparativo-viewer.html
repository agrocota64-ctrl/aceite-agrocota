<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agrocota - Comparativo de Decisão</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:          #040404;
      --surface:     #0e0e0e;
      --surface2:    #161616;
      --border:      #1e1e1e;
      --border2:     #2a2a2a;
      --primary:     #22c55e;
      --primary-dim: #021a09;
      --text:        #f0f0f0;
      --text-mid:    #666;
      --text-low:    #333;
      --red:         #ef4444;
      --amber:       #f59e0b;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* TOP BAR */
    .top-bar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(4,4,4,.88);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      padding: 13px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-size: .68rem; font-weight: 900; letter-spacing: .2em; color: var(--primary); text-transform: uppercase; }
    .status-pill {
      font-size: .58rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase;
      padding: 4px 10px; border-radius: 100px;
      border: 1px solid var(--amber); color: var(--amber);
    }
    .status-pill.aprovado { border-color: var(--primary); color: var(--primary); }

    /* PAGE */
    .page { max-width: 620px; margin: 0 auto; padding: 28px 16px 150px; }

    /* META */
    .meta-block { margin-bottom: 36px; }
    .meta-title { font-size: 1.5rem; font-weight: 900; line-height: 1.2; letter-spacing: -.02em; margin-bottom: 18px; }
    .meta-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 1px; background: var(--border);
      border: 1px solid var(--border); border-radius: 14px; overflow: hidden;
    }
    @media (max-width: 380px) { .meta-grid { grid-template-columns: 1fr; } }
    .meta-cell { background: var(--surface); padding: 12px 14px; }
    .meta-key { font-size: .6rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 3px; }
    .meta-val { font-size: .88rem; font-weight: 600; color: var(--text); }

    /* SECTION HEADER */
    .section-hd { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; margin-top: 36px; }
    .section-hd h2 { font-size: .62rem; font-weight: 800; letter-spacing: .14em; text-transform: uppercase; color: var(--text-mid); white-space: nowrap; }
    .section-line { flex: 1; height: 1px; background: var(--border); }

    /* CHART WRAP — identical to index */
    .chart-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px 20px;
      display: flex; flex-direction: column; align-items: center; gap: 28px;
    }
    .chart-canvas-wrap { position: relative; width: 190px; height: 190px; flex-shrink: 0; }
    canvas#donut { width: 190px !important; height: 190px !important; }
    .chart-center {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      text-align: center; pointer-events: none;
    }
    .chart-center-label { font-size: .55rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .chart-center-value { font-family: 'JetBrains Mono', monospace; font-size: .95rem; font-weight: 700; color: var(--text); display: block; line-height: 1.3; }
    .chart-legend { width: 100%; display: flex; flex-direction: column; gap: 9px; }
    .legend-row { display: flex; align-items: center; gap: 10px; }
    .legend-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .legend-name { flex: 1; font-size: .76rem; font-weight: 600; color: var(--text); }
    .legend-bar-wrap { flex: 1.5; height: 3px; background: var(--border2); border-radius: 99px; overflow: hidden; }
    .legend-bar { height: 100%; border-radius: 99px; transition: width .6s cubic-bezier(.4,0,.2,1); }
    .legend-val { font-family: 'JetBrains Mono', monospace; font-size: .72rem; font-weight: 700; min-width: 82px; text-align: right; }

    /* BAR CHART WRAP — same sizing as donut wrap */
    .bar-chart-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px 20px;
      display: flex; flex-direction: column; align-items: center; gap: 28px;
    }
    .bar-canvas-wrap { position: relative; width: 100%; }

    /* COTACAO CARDS */
    .cotacao-section { margin-bottom: 28px; }
    .cotacao-section-header {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 14px; margin-top: 28px;
      padding: 12px 14px 10px;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 12px; position: relative; overflow: hidden;
    }
    .cotacao-section-header::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0;
      height: 3px; opacity: 0.9;
    }
    .cotacao-section-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .cotacao-section-title { font-size: .88rem; font-weight: 900; color: var(--text); flex: 1; }
    .cotacao-section-total { font-family: 'JetBrains Mono', monospace; font-size: .72rem; font-weight: 700; color: var(--primary); white-space: nowrap; }

    /* PRODUCT OPTION CARDS — identical style to index */
    .option-card {
      display: flex; align-items: center; gap: 12px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px; margin-bottom: 8px;
      cursor: pointer; transition: border-color .18s, background .18s, transform .12s;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .option-card:active { transform: scale(.98); }
    .option-card.selected { border-color: var(--primary); background: var(--primary-dim); }
    .option-info { flex: 1; min-width: 0; }
    .option-forn { font-size: .83rem; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .option-cat  { font-size: .63rem; font-weight: 600; color: var(--text-mid); margin-top: 2px; }
    .option-price-col { text-align: right; flex-shrink: 0; }
    .option-price { font-family: 'JetBrains Mono', monospace; font-size: .95rem; font-weight: 700; }
    .option-badge {
      font-size: .54rem; font-weight: 900; letter-spacing: .08em; text-transform: uppercase;
      padding: 3px 7px; border-radius: 6px; background: var(--primary); color: #000;
      flex-shrink: 0;
    }
    .option-badge.menor { background: var(--primary); color: #000; }
    .option-badge.selecionada { background: var(--primary); color: #000; }

    /* PILL LIST for products inside each cotação card */
    .prod-pill-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
    .prod-pill {
      font-size: .62rem; font-weight: 600; padding: 4px 8px;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 6px; color: var(--text-mid);
    }

    /* APPROVED BANNER */
    .approved-card {
      background: var(--primary-dim); border: 1px solid var(--primary);
      border-radius: 18px; padding: 22px; text-align: center; margin-bottom: 28px;
    }
    .approved-title { font-size: .95rem; font-weight: 900; color: var(--primary); margin-bottom: 5px; }
    .approved-sub   { font-size: .75rem; color: var(--text-mid); }
    .approved-ts    { font-family: 'JetBrains Mono', monospace; font-size: .68rem; color: var(--primary); margin-top: 8px; }

    /* STICKY FOOTER */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      padding: 14px 16px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, var(--bg) 65%, transparent);
    }
    .footer-inner { max-width: 620px; margin: 0 auto; }
    .total-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; padding: 0 2px; }
    .total-label-sm { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .total-amount { font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 700; color: var(--text); }
    .total-sub { font-size: .58rem; color: var(--text-mid); text-align: right; display: block; }
    .btn-confirm {
      width: 100%; background: var(--primary); color: #000; border: none;
      padding: 16px 24px; border-radius: 15px; font-family: 'Inter', sans-serif; font-size: .75rem; font-weight: 900;
      letter-spacing: .1em; text-transform: uppercase; cursor: pointer;
      transition: opacity .18s, transform .12s; box-shadow: 0 0 40px rgba(34,197,94,.12);
    }
    .btn-confirm:active { transform: scale(.97); }
    .btn-confirm:disabled { opacity: .3; cursor: not-allowed; box-shadow: none; }

    /* MODAL */
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: flex-end; justify-content: center; padding: 16px;
      opacity: 0; pointer-events: none; transition: opacity .25s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 24px; padding: 26px 22px; width: 100%; max-width: 600px;
      transform: translateY(24px); transition: transform .3s cubic-bezier(.4,0,.2,1);
    }
    .modal-backdrop.open .modal { transform: translateY(0); }
    .modal-title { font-size: .95rem; font-weight: 900; margin-bottom: 5px; }
    .modal-sub   { font-size: .75rem; color: var(--text-mid); margin-bottom: 20px; }
    .modal-summary {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px; margin-bottom: 16px;
      max-height: 210px; overflow-y: auto;
    }
    .modal-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .modal-item:last-child { border-bottom: none; }
    .modal-item-name  { font-size: .78rem; font-weight: 600; }
    .modal-item-forn  { font-size: .63rem; color: var(--text-mid); margin-top: 2px; }
    .modal-item-price { font-family: 'JetBrains Mono', monospace; font-size: .76rem; font-weight: 700; color: var(--primary); flex-shrink: 0; margin-left: 12px; }
    .modal-total { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; padding-top: 12px; border-top: 1px solid var(--border2); }
    .modal-total-label { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .modal-total-val   { font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 900; color: var(--text); }
    .modal-actions { display: flex; gap: 10px; margin-top: 16px; }
    .btn-cancel {
      flex: 1; background: transparent; border: 1px solid var(--border2); color: var(--text-mid);
      padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif;
      font-size: .72rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase;
      cursor: pointer; transition: background .18s;
    }
    .btn-cancel:hover { background: var(--border); }
    .btn-confirm-modal {
      flex: 2; background: var(--primary); color: #000; border: none;
      padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif;
      font-size: .72rem; font-weight: 900; letter-spacing: .1em; text-transform: uppercase;
      cursor: pointer; transition: opacity .18s;
    }
    .btn-confirm-modal:disabled { opacity: .5; cursor: not-allowed; }

    .page-footer { text-align: center; padding: 12px 16px; font-size: .6rem; color: var(--text-low); letter-spacing: .06em; text-transform: uppercase; }
  </style>
</head>
<body>

<div class="top-bar">
  <span class="brand">Agrocota</span>
  <span class="status-pill" id="status-pill">Aguardando aceite</span>
</div>

<main class="page">

  <div class="meta-block">
    <h1 class="meta-title" id="meta-titulo">Comparativo de Cotação</h1>
    <div class="meta-grid" id="meta-grid"></div>
  </div>

  <div class="approved-card" id="approved-banner" style="display:none">
    <div class="approved-title">Aceite Registrado</div>
    <div class="approved-sub">Seu consultor foi notificado. Obrigado pela confirmação.</div>
    <div class="approved-ts" id="approved-ts"></div>
  </div>

  <!-- DONUT: Composição de custo (cotação selecionada ou menor) -->
  <div class="section-hd">
    <h2>Composição de Custo</h2>
    <div class="section-line"></div>
  </div>
  <div class="chart-wrap">
    <div class="chart-canvas-wrap">
      <canvas id="donut"></canvas>
      <div class="chart-center">
        <span class="chart-center-label">Investimento</span>
        <span class="chart-center-value" id="center-total">R$ 0,00</span>
      </div>
    </div>
    <div class="chart-legend" id="chart-legend"></div>
  </div>

  <!-- BAR CHART: Comparativo por produto entre cotações -->
  <div class="section-hd" style="margin-top:44px">
    <h2>Comparativo por Produto</h2>
    <div class="section-line"></div>
  </div>
  <div class="bar-chart-wrap">
    <div class="bar-canvas-wrap">
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <!-- SELECIONAR PROPOSTA -->
  <div class="section-hd" style="margin-top:44px">
    <h2>Selecione a Proposta</h2>
    <div class="section-line"></div>
  </div>
  <div id="option-list"></div>

</main>

<div class="sticky-footer" id="sticky-footer">
  <div class="footer-inner">
    <div class="total-row">
      <div>
        <div class="total-label-sm">Proposta Selecionada</div>
        <span class="total-sub" id="footer-sub">Nenhuma selecionada</span>
      </div>
      <div style="text-align:right">
        <div class="total-amount" id="footer-total">—</div>
      </div>
    </div>
    <button class="btn-confirm" id="btn-aceite" onclick="abrirModal()" disabled>Confirmar Aceite da Proposta</button>
  </div>
</div>

<!-- MODAL CONFIRMAÇÃO -->
<div class="modal-backdrop" id="modal-backdrop" onclick="fecharModalExterno(event)">
  <div class="modal">
    <div class="modal-title">Confirmar Aceite</div>
    <div class="modal-sub">Você está aprovando a proposta abaixo. Esta ação será registrada com data, hora e dispositivo.</div>
    <div class="modal-summary" id="modal-summary"></div>
    <div class="modal-total">
      <span class="modal-total-label">Investimento Total</span>
      <span class="modal-total-val" id="modal-total-val">R$ 0,00</span>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModal()">Voltar</button>
      <button class="btn-confirm-modal" id="btn-confirm-modal" onclick="confirmarAceite()">Confirmar Aceite</button>
    </div>
  </div>
</div>

<footer class="page-footer">Agrocota 2025 &mdash; Plataforma de Decisão Agrícola</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "seu-projeto.firebaseapp.com",
    projectId: "seu-projeto",
    storageBucket: "seu-projeto.appspot.com",
    messagingSenderId: "000000000000",
    appId: "1:000000000000:web:000000000"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ──── PALETA IDÊNTICA AO INDEX ────
  const PALETTE = [
    '#3B82F6','#EF4444','#F59E0B','#10B981',
    '#8B5CF6','#06B6D4','#EC4899','#84CC16',
    '#F97316','#14B8A6','#6366F1','#EAB308',
    '#22C55E','#A855F7','#0EA5E9','#FB7185',
  ];
  const COTACAO_COLORS = {};
  let _colorIdx = 0;
  function getCotacaoColor(titulo) {
    if (!COTACAO_COLORS[titulo]) {
      COTACAO_COLORS[titulo] = PALETTE[_colorIdx % PALETTE.length];
      _colorIdx++;
    }
    return COTACAO_COLORS[titulo];
  }

  const fmtBRL      = n  => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtDate     = s  => !s ? '—' : new Date(s).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fmtDateTime = s  => !s ? '—' : new Date(s).toLocaleString('pt-BR');
  const esc         = s  => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  // ──── PARSE URL ────
  const params      = new URLSearchParams(window.location.search);
  const dataEncoded = params.get('data');
  const cotacaoId   = params.get('id');

  // payload esperado: { meta: { titulo, fazenda, produtor, consultor, area, data }, cotacoes: [{ titulo, total, produtos: [{nome, valor}] }] }
  const payload = dataEncoded
    ? JSON.parse(atob(dataEncoded))
    : {
        meta: { titulo:'Comparativo de Safra', fazenda:'Fazenda Exemplo', produtor:'João Silva', consultor:'Carlos', area:'500', data: new Date().toISOString() },
        cotacoes: [
          { titulo:'Proposta A', total: 128000, produtos: [{nome:'Herbicida X', valor:42000},{nome:'Fungicida Y', valor:38000},{nome:'Inseticida Z', valor:28000},{nome:'Fertilizante', valor:20000}] },
          { titulo:'Proposta B', total: 145000, produtos: [{nome:'Herbicida X', valor:51000},{nome:'Fungicida Y', valor:41000},{nome:'Inseticida Z', valor:30000},{nome:'Fertilizante', valor:23000}] },
          { titulo:'Proposta C', total: 119000, produtos: [{nome:'Herbicida X', valor:38000},{nome:'Fungicida Y', valor:35000},{nome:'Inseticida Z', valor:25000},{nome:'Fertilizante', valor:21000}] },
        ]
      };

  let selecionado = null;
  let donutChart  = null;
  let barChart    = null;
  let aprovado    = false;

  // ──── META GRID ────
  function addMeta(key, val) {
    const g = document.getElementById('meta-grid');
    const c = document.createElement('div');
    c.className = 'meta-cell';
    c.innerHTML = '<div class="meta-key">'+key+'</div><div class="meta-val">'+esc(val||'—')+'</div>';
    g.appendChild(c);
  }

  document.getElementById('meta-titulo').textContent = payload.meta?.titulo || 'Comparativo';
  addMeta('Fazenda',   payload.meta?.fazenda);
  addMeta('Área',      payload.meta?.area ? payload.meta.area + ' ha' : '—');
  addMeta('Data',      payload.meta?.data ? fmtDate(payload.meta.data) : fmtDate(new Date().toISOString()));
  addMeta('Consultor', payload.meta?.consultor);

  // ──── DONUT: composição da cotação mais barata (ou selecionada) ────
  function buildDonut(cotacao) {
    const ctx = document.getElementById('donut').getContext('2d');
    if (donutChart) donutChart.destroy();

    const labels = cotacao.produtos.map(p => p.nome);
    const values = cotacao.produtos.map(p => p.valor);
    const colors = labels.map((_, i) => PALETTE[i % PALETTE.length]);
    const total  = values.reduce((a,b)=>a+b, 0);

    document.getElementById('center-total').textContent = 'R$ ' + fmtBRL(total);

    donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data: values, backgroundColor: colors, borderColor: '#040404', borderWidth: 3, hoverOffset: 8 }]
      },
      options: {
        cutout: '80%',
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ' R$ ' + fmtBRL(ctx.parsed) } }
        },
        animation: { duration: 700, easing: 'easeInOutQuart' }
      }
    });

    // legenda idêntica ao index
    const el = document.getElementById('chart-legend');
    el.innerHTML = '';
    cotacao.produtos.forEach((p, i) => {
      const pct = total > 0 ? (p.valor / total * 100) : 0;
      const row = document.createElement('div');
      row.className = 'legend-row';
      row.innerHTML =
        '<div class="legend-dot" style="background:'+colors[i]+'"></div>'
        + '<div class="legend-name">'+esc(p.nome)+' <span style="color:var(--text-mid)">('+pct.toFixed(1)+'%)</span></div>'
        + '<div class="legend-bar-wrap"><div class="legend-bar" style="width:'+pct.toFixed(1)+'%;background:'+colors[i]+'"></div></div>'
        + '<div class="legend-val" style="color:'+colors[i]+'">R$ '+fmtBRL(p.valor)+'</div>';
      el.appendChild(row);
    });
  }

  // ──── BAR CHART: por produto, uma barra por cotação ────
  function buildBarChart() {
    const ctx = document.getElementById('barChart').getContext('2d');
    if (barChart) barChart.destroy();

    // coleta todos os produtos únicos
    const produtosSet = new Set();
    payload.cotacoes.forEach(c => c.produtos.forEach(p => produtosSet.add(p.nome)));
    const produtos = [...produtosSet];

    const datasets = payload.cotacoes.map(c => {
      const color = getCotacaoColor(c.titulo);
      return {
        label: c.titulo,
        data: produtos.map(nome => {
          const item = c.produtos.find(p => p.nome === nome);
          return item ? item.valor : 0;
        }),
        backgroundColor: color,
        borderRadius: 8,
        barThickness: 24,
      };
    });

    barChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: produtos, datasets },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: { color: '#f0f0f0', font: { family: 'Inter', weight: '700', size: 11 }, boxWidth: 10, borderRadius: 4, padding: 16 }
          },
          tooltip: { callbacks: { label: ctx => ' ' + ctx.dataset.label + ': R$ ' + fmtBRL(ctx.parsed.x) } }
        },
        scales: {
          x: {
            grid: { color: '#1e1e1e' },
            ticks: { color: '#666', font: { family: 'JetBrains Mono', size: 10 },
              callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR',{minimumFractionDigits:0,maximumFractionDigits:0}) }
          },
          y: {
            ticks: { color: '#f0f0f0', font: { weight: '800', family: 'Inter', size: 11 } }
          }
        }
      }
    });

    // ajusta altura baseado em qtd de produtos × cotações
    const barHeight = 28 * payload.cotacoes.length + 10;
    const totalHeight = Math.max(160, produtos.length * barHeight + 60);
    document.getElementById('barChart').style.height = totalHeight + 'px';
  }

  // ──── CARDS DE SELEÇÃO ────
  function renderCards() {
    const container = document.getElementById('option-list');
    container.innerHTML = '';

    const minTotal = Math.min(...payload.cotacoes.map(c => c.total));

    payload.cotacoes.forEach((c) => {
      const color  = getCotacaoColor(c.titulo);
      const isMenor = c.total === minTotal;

      const section = document.createElement('div');
      section.className = 'cotacao-section';

      // header da cotação — igual cat-section-header do index
      const hdr = document.createElement('div');
      hdr.className = 'cotacao-section-header';
      hdr.style.setProperty('--hdr-color', color);
      hdr.innerHTML =
        '<style>.cotacao-section-header::before{background:' + color + '}</style>'
        + '<div class="cotacao-section-dot" style="background:'+color+'"></div>'
        + '<span class="cotacao-section-title">'+esc(c.titulo)+'</span>'
        + (isMenor ? '<span class="option-badge menor">Menor</span>' : '')
        + '<span class="cotacao-section-total">R$ '+fmtBRL(c.total)+'</span>';
      section.appendChild(hdr);

      // card clicável com produtos
      const card = document.createElement('div');
      card.className = 'option-card';
      card.setAttribute('data-idx', payload.cotacoes.indexOf(c));

      const prodPills = c.produtos.map(p =>
        '<span class="prod-pill">'+esc(p.nome)+' — R$ '+fmtBRL(p.valor)+'</span>'
      ).join('');

      card.innerHTML =
        '<div class="option-info">'
          + '<div class="option-forn">Selecionar esta proposta</div>'
          + '<div class="prod-pill-list">' + prodPills + '</div>'
        + '</div>'
        + '<div class="option-price-col">'
          + '<div class="option-price" style="color:'+color+'">R$ '+fmtBRL(c.total)+'</div>'
        + '</div>';

      card.onclick = () => selecionar(c, card);
      section.appendChild(card);
      container.appendChild(section);
    });
  }

  function selecionar(c, card) {
    if (aprovado) return;
    document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
    card.classList.add('selected');
    selecionado = c;

    document.getElementById('footer-sub').textContent   = c.titulo;
    document.getElementById('footer-total').textContent = 'R$ ' + fmtBRL(c.total);
    document.getElementById('btn-aceite').disabled      = false;

    // atualiza donut para a cotação selecionada
    buildDonut(c);
  }

  // ──── MODAL ────
  window.abrirModal = () => {
    if (!selecionado) return;
    const el = document.getElementById('modal-summary');
    el.innerHTML = '';
    selecionado.produtos.forEach(p => {
      const row = document.createElement('div');
      row.className = 'modal-item';
      row.innerHTML =
        '<div><div class="modal-item-name">'+esc(p.nome)+'</div></div>'
        + '<div class="modal-item-price">R$ '+fmtBRL(p.valor)+'</div>';
      el.appendChild(row);
    });
    document.getElementById('modal-total-val').textContent = 'R$ ' + fmtBRL(selecionado.total);
    document.getElementById('modal-backdrop').classList.add('open');
  };

  window.fecharModal = () => document.getElementById('modal-backdrop').classList.remove('open');
  window.fecharModalExterno = (e) => { if (e.target === document.getElementById('modal-backdrop')) fecharModal(); };

  window.confirmarAceite = async () => {
    if (!selecionado) return;
    const btn = document.getElementById('btn-confirm-modal');
    btn.disabled = true; btn.textContent = 'Registrando...';
    try {
      await updateDoc(doc(db, 'cotacoes', cotacaoId), {
        status: 'Aprovada',
        fornecedorVencedor: selecionado.titulo,
        valorAprovado: selecionado.total,
        dataAceite: new Date().toISOString()
      });
      fecharModal();
      setAprovado(new Date().toISOString());
    } catch(e) {
      alert('Erro ao gravar no banco de dados.');
    } finally {
      btn.disabled = false; btn.textContent = 'Confirmar Aceite';
    }
  };

  function setAprovado(ts) {
    aprovado = true;
    const pill = document.getElementById('status-pill');
    pill.textContent  = 'Aceite registrado';
    pill.className    = 'status-pill aprovado';
    document.getElementById('approved-banner').style.display = 'block';
    document.getElementById('approved-ts').textContent = 'Registrado em ' + fmtDateTime(ts);
    document.getElementById('sticky-footer').style.display = 'none';
  }

  // ──── INIT ────
  function init() {
    // cotação mais barata como padrão para o donut
    const menor = [...payload.cotacoes].sort((a,b) => a.total - b.total)[0];
    if (menor) buildDonut(menor);
    buildBarChart();
    renderCards();
    // atribuir cores às cotações antes de render
    payload.cotacoes.forEach(c => getCotacaoColor(c.titulo));
  }

  init();
</script>
</body>
</html>
