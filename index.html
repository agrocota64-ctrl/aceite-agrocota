<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agrocota ‚Äì Painel de Decis√£o</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    /* ‚îÄ‚îÄ TOKENS ‚îÄ‚îÄ */
    :root {
      --bg: #040404; --surface: #0e0e0e; --surface2: #161616;
      --border: #1e1e1e; --border2: #2a2a2a;
      --primary: #22c55e; --primary-dim: #021a09;
      --text: #f0f0f0; --text-mid: #666; --text-low: #333;
      --red: #ef4444; --amber: #f59e0b; --blue: #3b82f6;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }

    /* ‚îÄ‚îÄ STATES ‚îÄ‚îÄ */
    #state-loading, #state-error {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 100svh; gap: 16px;
    }
    #state-error { padding: 32px; text-align: center; }
    .loader { width: 32px; height: 32px; border: 2px solid var(--border2); border-top-color: var(--primary); border-radius: 50%; animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .state-label { font-size: .7rem; font-weight: 700; letter-spacing: .1em; color: var(--text-mid); text-transform: uppercase; }
    .err-title { font-size: .95rem; font-weight: 800; color: var(--red); }
    .err-body { font-size: .78rem; color: var(--text-mid); margin-top: 6px; }

    /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
    .top-bar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(4,4,4,.9); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border); padding: 13px 20px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .brand { font-size: .68rem; font-weight: 900; letter-spacing: .2em; color: var(--primary); text-transform: uppercase; flex-shrink: 0; }
    .top-bar-right { display: flex; align-items: center; gap: 10px; }
    .status-pill {
      font-size: .58rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase;
      padding: 4px 10px; border-radius: 100px; border: 1px solid var(--border2); color: var(--text-mid);
    }
    .status-pill.pendente  { border-color: var(--amber); color: var(--amber); }
    .status-pill.aprovado  { border-color: var(--primary); color: var(--primary); }
    .status-pill.recusado  { border-color: var(--red); color: var(--red); }
    .btn-pdf {
      font-size: .58rem; font-weight: 800; letter-spacing: .08em; text-transform: uppercase;
      padding: 4px 12px; border-radius: 100px; background: var(--primary); color: #000;
      border: none; cursor: pointer; transition: opacity .15s;
    }
    .btn-pdf:hover { opacity: .85; }

    /* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
    .page { max-width: 700px; margin: 0 auto; padding: 28px 16px 180px; }

    /* ‚îÄ‚îÄ HEADER SECTION (Consultor / Fazenda) ‚îÄ‚îÄ */
    .header-block {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 28px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .logo-box {
      width: 64px; height: 64px; flex-shrink: 0;
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 14px; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .logo-box img { width: 100%; height: 100%; object-fit: contain; }
    .logo-fallback { font-size: .55rem; font-weight: 700; color: var(--text-mid); text-align: center; line-height: 1.3; }
    .header-info { flex: 1; min-width: 0; }
    .doc-title { font-size: 1.3rem; font-weight: 900; letter-spacing: -.02em; line-height: 1.2; margin-bottom: 12px; }
    .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    @media(max-width: 400px) { .meta-grid { grid-template-columns: 1fr; } }
    .meta-cell { background: var(--surface); padding: 10px 12px; }
    .meta-cell.full { grid-column: 1 / -1; }
    .meta-key { font-size: .58rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 3px; }
    .meta-val { font-size: .85rem; font-weight: 600; color: var(--text); }
    .whatsapp-btn {
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 12px; padding: 8px 14px; border-radius: 10px;
      background: #022710; border: 1px solid rgba(34,197,94,.3);
      font-size: .72rem; font-weight: 700; color: var(--primary); text-decoration: none;
      transition: background .15s;
    }
    .whatsapp-btn:hover { background: #033a18; }

    /* ‚îÄ‚îÄ ACEITE BANNER ‚îÄ‚îÄ */
    .approved-card { background: var(--primary-dim); border: 1px solid var(--primary); border-radius: 18px; padding: 22px; text-align: center; margin-bottom: 28px; }
    .approved-card.recusado { background: rgba(239,68,68,.08); border-color: var(--red); }
    .approved-card.recusado .approved-title, .approved-card.recusado .approved-ts { color: var(--red); }
    .approved-title { font-size: .95rem; font-weight: 900; color: var(--primary); margin-bottom: 5px; }
    .approved-sub { font-size: .75rem; color: var(--text-mid); }
    .approved-ts { font-family: 'JetBrains Mono', monospace; font-size: .68rem; color: var(--primary); margin-top: 8px; }

    /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
    .section-hd { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; margin-top: 36px; }
    .section-hd h2 { font-size: .62rem; font-weight: 800; letter-spacing: .14em; text-transform: uppercase; color: var(--text-mid); white-space: nowrap; }
    .section-line { flex: 1; height: 1px; background: var(--border); }

    /* ‚îÄ‚îÄ TOTAL BOX ‚îÄ‚îÄ */
    .total-box {
      background: var(--surface); border: 1px solid var(--border2);
      border-radius: 18px; padding: 20px 22px;
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px;
    }
    .total-box-label { font-size: .65rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 3px; }
    .total-box-sub { font-size: .65rem; color: var(--text-mid); }
    .total-box-val { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--primary); text-align: right; }

    /* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
    .chart-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 28px 20px; display: flex; flex-direction: column; align-items: center; gap: 28px; }
    .chart-canvas-wrap { position: relative; width: 200px; height: 200px; flex-shrink: 0; }
    canvas#donut { width: 200px !important; height: 200px !important; }
    .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .chart-center-label { font-size: .55rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .chart-center-value { font-family: 'JetBrains Mono', monospace; font-size: .95rem; font-weight: 700; color: var(--text); display: block; line-height: 1.3; }
    .chart-legend { width: 100%; display: flex; flex-direction: column; gap: 9px; }
    .legend-row { display: flex; align-items: center; gap: 10px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .legend-name { flex: 1; font-size: .76rem; font-weight: 600; color: var(--text); }
    .legend-bar-wrap { flex: 1.5; height: 4px; background: var(--border2); border-radius: 99px; overflow: hidden; }
    .legend-bar { height: 100%; border-radius: 99px; }
    .legend-val { font-family: 'JetBrains Mono', monospace; font-size: .72rem; font-weight: 700; min-width: 88px; text-align: right; }

    /* ‚îÄ‚îÄ CATEGORIA TABLE BLOCK (like PDF) ‚îÄ‚îÄ */
    .cat-detail-wrapper { margin-bottom: 8px; border-radius: 14px; overflow: hidden; border: 1px solid var(--border); }
    .cat-detail-header { padding: 10px 16px; color: #fff; font-size: .78rem; font-weight: 900; text-transform: uppercase; letter-spacing: .08em; display: flex; align-items: center; justify-content: space-between; }
    .cat-detail-header-right { font-size: .7rem; font-weight: 700; opacity: .85; }
    .cat-detail-table { width: 100%; border-collapse: collapse; }
    .cat-detail-table th {
      background: #111; font-size: .58rem; color: var(--text-mid);
      padding: 7px 14px; text-transform: uppercase; letter-spacing: .06em;
      border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap;
    }
    .cat-detail-table th.num { text-align: right; }
    .cat-detail-table td { padding: 9px 14px; border-bottom: 1px solid var(--border); font-size: .8rem; color: var(--text); vertical-align: top; }
    .cat-detail-table tr:last-child td { border-bottom: none; }
    .cat-detail-table tr.highlight-min td { background: rgba(34,197,94,.04); }
    .cat-detail-table tr.highlight-max td { background: rgba(239,68,68,.03); }
    .prod-name-cell { font-weight: 800; font-size: .85rem; color: var(--text); margin-bottom: 5px; }
    /* ‚îÄ‚îÄ Chips inline ‚îÄ‚îÄ */
    .chips-row {
      display: flex !important; flex-direction: row !important;
      flex-wrap: wrap; gap: 4px; margin-top: 6px; align-items: center;
    }
    .chip-pa, .chip-fonte, .badge {
      display: inline-flex !important; align-items: center; gap: 3px;
      padding: 2px 7px; border-radius: 4px;
      font-size: .57rem; font-weight: 700; white-space: nowrap; line-height: 1.4;
    }
    .chip-pa   { background: #022710; border: 1px solid rgba(34,197,94,.35); color: #4ade80; }
    .chip-fonte { background: #0f172a; border: 1px solid rgba(96,165,250,.35); color: #60a5fa; }
    .badge     { background: var(--surface2); border: 1px solid var(--border2); color: var(--text); }
    .ck { opacity: .55; font-size: .5rem; text-transform: uppercase; letter-spacing: .06em; margin-right: 2px; }
    .badge b { color: var(--text); font-weight: 700; }
    .badge-key { opacity: .6; font-size: .52rem; text-transform: uppercase; letter-spacing: .05em; }
    /* Fornecedor + badges por linha */
    .forn-cell { font-size: .82rem; font-weight: 700; color: var(--text); }
    .badge-menor { display: inline-block; font-size: .52rem; font-weight: 900; letter-spacing: .08em; text-transform: uppercase; padding: 2px 7px; border-radius: 5px; background: var(--primary); color: #000; margin-left: 6px; }
    .badge-maior { display: inline-block; font-size: .52rem; font-weight: 900; letter-spacing: .08em; text-transform: uppercase; padding: 2px 7px; border-radius: 5px; background: rgba(239,68,68,.15); color: var(--red); border: 1px solid rgba(239,68,68,.3); margin-left: 6px; }
    .num { text-align: right; font-variant-numeric: tabular-nums; font-family: 'JetBrains Mono', monospace; }
    .val-strong { font-size: .88rem; font-weight: 800; }

    /* Rowspan-style product name grouping */
    td.prod-group-cell { border-right: 1px solid var(--border); min-width: 160px; }

    /* ‚îÄ‚îÄ STICKY FOOTER ‚îÄ‚îÄ */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      padding: 14px 16px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, var(--bg) 65%, transparent);
    }
    .footer-inner { max-width: 700px; margin: 0 auto; }
    .total-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; padding: 0 2px; }
    .total-label-sm { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .total-amount { font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 700; color: var(--text); }
    .total-sub { font-size: .58rem; color: var(--text-mid); text-align: right; display: block; }
    .footer-actions { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; }
    .btn-confirm {
      width: 100%; background: var(--primary); color: #000; border: none;
      padding: 16px 24px; border-radius: 15px;
      font-family: 'Inter', sans-serif; font-size: .75rem; font-weight: 900;
      letter-spacing: .1em; text-transform: uppercase;
      cursor: pointer; transition: opacity .18s, transform .12s;
      box-shadow: 0 0 40px rgba(34,197,94,.12);
    }
    .btn-confirm:active { transform: scale(.97); }
    .btn-confirm:disabled { opacity: .3; cursor: not-allowed; box-shadow: none; }
    .btn-reject {
      width: 100%; background: transparent; color: #fca5a5;
      border: 1px solid rgba(239,68,68,.45); padding: 16px 14px; border-radius: 15px;
      font-family: 'Inter', sans-serif; font-size: .72rem; font-weight: 900;
      letter-spacing: .08em; text-transform: uppercase;
      cursor: pointer; transition: opacity .18s, transform .12s;
    }
    .btn-reject:active { transform: scale(.97); }
    .btn-reject:disabled { opacity: .35; cursor: not-allowed; }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: flex-end; justify-content: center; padding: 16px;
      opacity: 0; pointer-events: none; transition: opacity .25s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface2); border: 1px solid var(--border2); border-radius: 24px;
      padding: 26px 22px; width: 100%; max-width: 680px;
      transform: translateY(24px); transition: transform .3s cubic-bezier(.4,0,.2,1);
      max-height: 88svh; display: flex; flex-direction: column;
    }
    .modal-backdrop.open .modal { transform: translateY(0); }
    .modal-title { font-size: .95rem; font-weight: 900; margin-bottom: 5px; flex-shrink: 0; }
    .modal-sub { font-size: .75rem; color: var(--text-mid); margin-bottom: 16px; flex-shrink: 0; }
    .modal-scroll { overflow-y: auto; flex: 1; }
    .modal-item { padding: 11px 0; border-bottom: 1px solid var(--border); }
    .modal-item:last-child { border-bottom: none; }
    .modal-item-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
    .modal-item-name { font-size: .82rem; font-weight: 700; color: var(--text); flex: 1; }
    .modal-item-price { font-family: 'JetBrains Mono', monospace; font-size: .82rem; font-weight: 700; color: var(--primary); flex-shrink: 0; }
    .modal-item-chips { display: flex; flex-wrap: wrap; gap: 5px; }
    .modal-chip { font-size: .6rem; font-weight: 600; padding: 2px 7px; border-radius: 5px; background: var(--surface); border: 1px solid var(--border); color: var(--text-mid); }
    .modal-chip b { color: var(--text); font-weight: 700; }
    .modal-total { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 14px; border-top: 1px solid var(--border2); flex-shrink: 0; }
    .modal-total-label { font-size: .62rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-mid); }
    .modal-total-val { font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 900; color: var(--text); }
    .modal-actions { display: flex; gap: 10px; margin-top: 16px; flex-shrink: 0; }
    .btn-cancel { flex: 1; background: transparent; border: 1px solid var(--border2); color: var(--text-mid); padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif; font-size: .72rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; cursor: pointer; transition: background .18s; }
    .btn-cancel:hover { background: var(--border); }
    .btn-confirm-modal { flex: 2; background: var(--primary); color: #000; border: none; padding: 14px; border-radius: 12px; font-family: 'Inter', sans-serif; font-size: .72rem; font-weight: 900; letter-spacing: .1em; text-transform: uppercase; cursor: pointer; transition: opacity .18s; }
    .btn-confirm-modal:disabled { opacity: .5; cursor: not-allowed; }

    .page-footer { text-align: center; padding: 12px 16px; font-size: .6rem; color: var(--text-low); letter-spacing: .06em; text-transform: uppercase; }

    /* ‚îÄ‚îÄ PRINT / PDF ‚îÄ‚îÄ */
    @media print {
      body { background: #fff !important; color: #111 !important; }
      .top-bar, .sticky-footer, .modal-backdrop, .btn-pdf { display: none !important; }
      .page { padding: 0 !important; max-width: 100% !important; }
      .chart-wrap, .meta-cell, .cat-detail-wrapper, .badge, .chip-pa, .chip-fonte { background: #f8f8f8 !important; border-color: #ddd !important; color: #111 !important; }
      .approved-card { background: #e8f5e9 !important; border-color: #4caf50 !important; }
      canvas { max-width: 160px !important; }
      .cat-detail-wrapper, .cat-detail-table tr { break-inside: avoid; }
    }
  </style>
</head>
<body>

<div id="state-loading">
  <div class="loader"></div>
  <span class="state-label">Carregando cota√ß√£o</span>
</div>
<div id="state-error" style="display:none">
  <span class="err-title" id="err-title">Link inv√°lido ou expirado</span>
  <p class="err-body">Solicite um novo link ao consultor respons√°vel.</p>
</div>

<div id="app" style="display:none">
  <div class="top-bar">
    <span class="brand">Agrocota</span>
    <div class="top-bar-right">
      <button class="btn-pdf" onclick="window.print()">Baixar PDF</button>
      <span class="status-pill pendente" id="status-pill">Aguardando aceite</span>
    </div>
  </div>

  <main class="page">

    <!-- HEADER: logo + metadados (igual ao PDF) -->
    <div class="header-block" id="header-block">
      <div class="logo-box" id="logo-box">
        <span class="logo-fallback">Sem<br/>Logo</span>
      </div>
      <div class="header-info">
        <h1 class="doc-title" id="meta-titulo">Cota√ß√£o</h1>
        <div class="meta-grid" id="meta-grid"></div>
        <a class="whatsapp-btn" id="whatsapp-btn" style="display:none" target="_blank" rel="noopener">
          üí¨ Falar no WhatsApp: <span id="whatsapp-phone"></span>
        </a>
      </div>
    </div>

    <!-- ACEITE BANNER -->
    <div class="approved-card" id="approved-banner" style="display:none">
      <div class="approved-title" id="approved-title">Aceite Registrado</div>
      <div class="approved-sub">Seu consultor foi notificado. Obrigado pela confirma√ß√£o.</div>
      <div class="approved-ts" id="approved-ts"></div>
    </div>

    <!-- TOTAL BOX (como no PDF) -->
    <div class="total-box" id="total-box" style="display:none">
      <div>
        <div class="total-box-label">Investimento Total</div>
        <div class="total-box-sub" id="total-box-sub">Resumo baseado nas op√ß√µes de menor custo</div>
      </div>
      <div class="total-box-val" id="total-box-val">R$ 0,00</div>
    </div>

    <!-- COMPOSI√á√ÉO DE CUSTO -->
    <div class="section-hd">
      <h2>Composi√ß√£o de Custo</h2>
      <div class="section-line"></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-canvas-wrap">
        <canvas id="donut"></canvas>
        <div class="chart-center">
          <span class="chart-center-label">Investimento</span>
          <span class="chart-center-value" id="center-total">R$ 0,00</span>
        </div>
      </div>
      <div class="chart-legend" id="chart-legend"></div>
    </div>

    <!-- DETALHAMENTO (igual ao PDF: tabelas por categoria) -->
    <div class="section-hd" style="margin-top:44px">
      <h2>Detalhamento Completo dos Insumos</h2>
      <div class="section-line"></div>
    </div>
    <div id="prod-list"></div>

  </main>

  <!-- STICKY FOOTER -->
  <div class="sticky-footer" id="sticky-footer">
    <div class="footer-inner">
      <div class="total-row">
        <div>
          <div class="total-label-sm">Investimento Total</div>
          <span class="total-sub" id="footer-count">0 produtos</span>
        </div>
        <div style="text-align:right">
          <div class="total-amount" id="footer-total">R$ 0,00</div>
        </div>
      </div>
      <div class="footer-actions">
        <button class="btn-reject" id="btn-recusar" onclick="abrirModalRecusa()">Recusar</button>
        <button class="btn-confirm" id="btn-aceite" onclick="abrirModal()" disabled>Confirmar Aceite</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL RECUSA -->
<div class="modal-backdrop" id="modal-recusar-backdrop" onclick="fecharModalRecusaExterno(event)">
  <div class="modal" style="max-height:unset">
    <div class="modal-title">Confirmar Recusa</div>
    <div class="modal-sub">Ao recusar, o consultor ser√° notificado e esta cota√ß√£o ficar√° como recusada.</div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModalRecusa()">Voltar</button>
      <button class="btn-confirm-modal" id="btn-recusar-modal" onclick="confirmarRecusa()" style="background:#ef4444;color:#fff">Confirmar Recusa</button>
    </div>
  </div>
</div>

<!-- MODAL ACEITE -->
<div class="modal-backdrop" id="modal-backdrop" onclick="fecharModalExterno(event)">
  <div class="modal">
    <div class="modal-title">Confirmar Aceite</div>
    <div class="modal-sub">Revise os itens abaixo antes de confirmar. Esta a√ß√£o registrar√° data, hora e dispositivo.</div>
    <div class="modal-scroll" id="modal-summary"></div>
    <div class="modal-total">
      <span class="modal-total-label">Investimento Total</span>
      <span class="modal-total-val" id="modal-total-val">R$ 0,00</span>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="fecharModal()">Voltar</button>
      <button class="btn-confirm-modal" id="btn-confirm-modal" onclick="confirmarAceite()">Confirmar Aceite</button>
    </div>
  </div>
</div>

<footer class="page-footer">Agrocota 2025 ‚Äî Plataforma de Decis√£o Agr√≠cola</footer>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SUPABASE_URL  = 'https://fafjknchnibdflpqyssf.supabase.co';
const SUPABASE_ANON = 'sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r';

/* Paleta igual ao CotacaoPdfExportService (PRODUTOR_PALETTE) */
const PALETTE = [
  '#1B5E20','#F57C00','#C62828','#1565C0','#00838F',
  '#6A1B9A','#4E342E','#0277BD','#EF6C00','#558B2F',
  '#00695C','#880E4F','#1A237E','#BF360C','#006064',
  '#F9A825','#4A148C','#37474F','#E65100','#283593',
];

/* CAT_COLORS mapeado alfabeticamente (mesma l√≥gica do PDF service) */
const CAT_COLORS_MAP = {};
let _catPaletteIdx = 0;

function getCatColor(cat) {
  if (!CAT_COLORS_MAP[cat]) {
    CAT_COLORS_MAP[cat] = PALETTE[_catPaletteIdx % PALETTE.length];
    _catPaletteIdx++;
  }
  return CAT_COLORS_MAP[cat];
}

/* Pr√©-inicializa cores na ordem alfab√©tica (como o PDF service faz) */
function initCatColors(categorias) {
  const sorted = [...new Set(categorias)].sort((a, b) => a.localeCompare(b));
  sorted.forEach(cat => getCatColor(cat));
}

let chart = null;
let cotacao = null;
let allItens = [];
let approved = false;
let areaFactor = 1;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const fmtBRL = n => Number(n || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtDate = s => !s ? '‚Äî' : new Date(s).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
const fmtDateTime = s => !s ? '‚Äî' : new Date(s).toLocaleString('pt-BR');
const esc = s => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function normBrPhone(raw) {
  const digits = String(raw || '').replace(/\D/g, '');
  if (!digits) return '';
  return digits.startsWith('55') ? digits : '55' + digits;
}
function formatBrPhone(raw) {
  const norm = normBrPhone(raw);
  if (!norm) return '';
  const local = norm.slice(2);
  if (local.length === 11) return `(${local.slice(0,2)}) ${local.slice(2,7)}-${local.slice(7)}`;
  if (local.length === 10) return `(${local.slice(0,2)}) ${local.slice(2,6)}-${local.slice(6)}`;
  return '+' + norm;
}

async function rpc(fn, params) {
  const r = await fetch(SUPABASE_URL + '/rest/v1/rpc/' + fn, {
    method: 'POST',
    headers: { apikey: SUPABASE_ANON, Authorization: 'Bearer ' + SUPABASE_ANON, 'Content-Type': 'application/json' },
    body: JSON.stringify(params),
  });
  if (!r.ok) throw new Error('Erro na comunica√ß√£o com servidor.');
  return r.json();
}

function showError(msg) {
  document.getElementById('state-loading').style.display = 'none';
  document.getElementById('state-error').style.display = 'flex';
  if (msg) document.getElementById('err-title').textContent = msg;
}

function addMeta(key, val, full) {
  const g = document.getElementById('meta-grid');
  const c = document.createElement('div');
  c.className = 'meta-cell' + (full ? ' full' : '');
  c.innerHTML = '<div class="meta-key">' + esc(key) + '</div><div class="meta-val">' + esc(String(val || '‚Äî')) + '</div>';
  g.appendChild(c);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHART
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildChart(labels, values, colors) {
  const ctx = document.getElementById('donut').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#040404', borderWidth: 3, hoverOffset: 8 }] },
    options: {
      cutout: '80%',
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ' R$ ' + fmtBRL(c.parsed) } } },
      animation: { duration: 700, easing: 'easeInOutQuart' },
    },
  });
}

function buildLegend(entries, colors, total) {
  const el = document.getElementById('chart-legend');
  el.innerHTML = '';
  entries.forEach(([cat, val], i) => {
    const pct = total > 0 ? (val / total * 100) : 0;
    const row = document.createElement('div');
    row.className = 'legend-row';
    row.innerHTML =
      '<div class="legend-dot" style="background:' + colors[i] + '"></div>'
    + '<div class="legend-name">' + esc(cat) + ' <span style="color:var(--text-mid)">(' + pct.toFixed(1) + '%)</span></div>'
    + '<div class="legend-bar-wrap"><div class="legend-bar" style="width:' + pct.toFixed(1) + '%;background:' + colors[i] + '"></div></div>'
    + '<div class="legend-val" style="color:' + colors[i] + '">R$ ' + fmtBRL(val) + '</div>';
    el.appendChild(row);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOTAL C√ÅLCULO
   ‚Äî usa menor valor_ha por produto dentro de cada categoria
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function calcTotais(itens) {
  /* agrupa por cat‚Üíproduto, pega o menor valor */
  const m = {};
  itens.forEach(it => {
    if (!it.produto_nome) return;
    const cat = it.categoria || 'Insumo';
    const key = cat + '||' + it.produto_nome;
    if (!m[key] || Number(it.valor_ha || 0) < Number(m[key])) m[key] = Number(it.valor_ha || 0);
  });
  return Object.values(m).reduce((a, v) => a + v, 0);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER PRODUTOS ‚Äî estrutura de tabela igual ao PDF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderProdutos(itens) {
  /* 1. Agrupa por categoria ‚Üí produto */
  const byCat = {};
  itens.forEach(it => {
    if (!it.produto_nome) return;
    const cat = it.categoria || 'Insumo';
    if (!byCat[cat]) byCat[cat] = {};
    if (!byCat[cat][it.produto_nome]) byCat[cat][it.produto_nome] = [];
    byCat[cat][it.produto_nome].push(it);
  });

  /* 2. Ordena categorias pela soma m√≠nima (maior primeiro ‚Äî igual ao PDF) */
  const catEntries = Object.entries(byCat).map(([cat, prods]) => {
    const somaMin = Object.values(prods).reduce((s, opts) => {
      const sv = [...opts].sort((a, b) => (a.valor_ha || 0) - (b.valor_ha || 0));
      return s + Number(sv[0]?.valor_ha || 0);
    }, 0);
    return { cat, prods, somaMin };
  });
  catEntries.sort((a, b) => b.somaMin - a.somaMin);

  const container = document.getElementById('prod-list');
  container.innerHTML = '';

  catEntries.forEach(({ cat, prods, somaMin }) => {
    const color = getCatColor(cat);
    const numProdutos = Object.keys(prods).length;

    const wrapper = document.createElement('div');
    wrapper.className = 'cat-detail-wrapper';
    wrapper.style.marginBottom = '12px';

    /* ‚îÄ‚îÄ Cabe√ßalho da categoria (colorido) ‚îÄ‚îÄ */
    wrapper.innerHTML = `
      <div class="cat-detail-header" style="background:${color}">
        <span>${esc(cat)}</span>
        <span class="cat-detail-header-right">${numProdutos} produto${numProdutos !== 1 ? 's' : ''} &nbsp;|&nbsp; R$ ${fmtBRL(somaMin)}</span>
      </div>
    `;

    /* ‚îÄ‚îÄ Tabela (Produto / Fornecedor / Dose / Valor/ha) ‚îÄ‚îÄ */
    const table = document.createElement('table');
    table.className = 'cat-detail-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th style="width:38%">Produto / P.A. / Detalhes</th>
          <th style="width:28%">Fornecedor</th>
          <th class="num" style="width:15%">Dose</th>
          <th class="num" style="width:19%">Valor/ha</th>
        </tr>
      </thead>
      <tbody id="tbody-${esc(cat.replace(/\s/g,'_'))}"></tbody>
    `;

    const tbody = table.querySelector('tbody');

    /* Ordena produtos alfabeticamente */
    const prodEntries = Object.entries(prods).sort((a, b) => a[0].localeCompare(b[0]));

    prodEntries.forEach(([nome, opts]) => {
      const sorted = [...opts].sort((a, b) => (a.valor_ha || 0) - (b.valor_ha || 0));
      const minVal = Number(sorted[0]?.valor_ha || 0);
      const maxVal = Number(sorted[sorted.length - 1]?.valor_ha || 0);
      const nOps   = sorted.length;

      /* Refer√™ncia para chips de produto (PA, Fonte) ‚Äî usa o primeiro item */
      const ref = sorted[0];
      /* Monta array de chips ‚Äî todos inline num √∫nico flex row */
      const chipsArr = [];
      const pa    = String(ref.principio_ativo || '').trim();
      const fonte = String(ref.fonte           || '').trim();
      if (pa)                chipsArr.push('<span class="chip-pa"><span class="ck">P.A.</span> ' + esc(pa) + '</span>');
      if (fonte)             chipsArr.push('<span class="chip-fonte"><span class="ck">Fonte</span> ' + esc(fonte) + '</span>');
      if (ref.estagio)       chipsArr.push('<span class="badge"><span class="ck">Est√°dio</span> ' + esc(ref.estagio) + '</span>');
      if (ref.n_aplicacoes)  chipsArr.push('<span class="badge"><span class="ck">Aplic.</span> ' + esc(ref.n_aplicacoes) + 'x</span>');
      if (ref.alvo)          chipsArr.push('<span class="badge"><span class="ck">Alvo</span> ' + esc(ref.alvo) + '</span>');
      if (ref.tecnologia)    chipsArr.push('<span class="badge"><span class="ck">Tecnol.</span> ' + esc(ref.tecnologia) + '</span>');
      if (ref.grupo_alvo)    chipsArr.push('<span class="badge"><span class="ck">Grupo</span> ' + esc(ref.grupo_alvo) + '</span>');
      if (ref.campo_adicional) chipsArr.push('<span class="badge"><span class="ck">Campo</span> ' + esc(ref.campo_adicional) + '</span>');
      if (ref.obs)           chipsArr.push('<span class="badge"><span class="ck">Obs</span> ' + esc(ref.obs) + '</span>');
      const chipsHtml = chipsArr.length ? '<div class="chips-row">' + chipsArr.join('') + '</div>' : '';

      const prodCellHtml = '<div class="prod-name-cell">' + esc(nome) + '</div>' + chipsHtml;

      sorted.forEach((it, opIdx) => {
        const isMin = nOps > 1 && Number(it.valor_ha || 0) === minVal;
        const isMax = nOps > 1 && Number(it.valor_ha || 0) === maxVal && minVal !== maxVal;

        const tr = document.createElement('tr');
        if (isMin) tr.className = 'highlight-min';
        if (isMax) tr.className = 'highlight-max';

        const minBadge = isMin ? '<span class="badge-menor">Menor</span>' : '';
        const maxBadge = isMax ? '<span class="badge-maior">Maior</span>' : '';

        const doseStr = (it.dose_ha != null && it.dose_ha !== '' && it.dose_ha !== 0)
          ? fmtBRL(Number(it.dose_ha)) + (it.unidade ? ' ' + it.unidade : '')
          : '‚Äî';

        const fornecedor = it.fornecedor === 'N/I' ? 'Fornecedor Direto' : (it.fornecedor || 'Fornecedor Direto');

        if (opIdx === 0) {
          tr.innerHTML = `
            <td class="prod-group-cell" rowspan="${nOps}">${prodCellHtml}</td>
            <td class="forn-cell">${esc(fornecedor)}${minBadge}${maxBadge}</td>
            <td class="num" style="font-size:.8rem">${esc(doseStr)}</td>
            <td class="num val-strong" style="color:${isMin ? 'var(--primary)' : (isMax ? 'var(--red)' : 'var(--text)')}">
              R$ ${fmtBRL(it.valor_ha || 0)}
            </td>
          `;
        } else {
          tr.innerHTML = `
            <td class="forn-cell">${esc(fornecedor)}${minBadge}${maxBadge}</td>
            <td class="num" style="font-size:.8rem">${esc(doseStr)}</td>
            <td class="num val-strong" style="color:${isMin ? 'var(--primary)' : (isMax ? 'var(--red)' : 'var(--text)')}">
              R$ ${fmtBRL(it.valor_ha || 0)}
            </td>
          `;
        }
        tbody.appendChild(tr);
      });
    });

    wrapper.appendChild(table);
    container.appendChild(wrapper);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SYNC ‚Äî atualiza totais, legenda, gr√°fico
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sync(itens) {
  const total = calcTotais(itens);
  document.getElementById('footer-total').textContent = 'R$ ' + fmtBRL(total);
  document.getElementById('center-total').textContent = 'R$ ' + fmtBRL(total);
  document.getElementById('total-box-val').textContent = 'R$ ' + fmtBRL(total);
  document.getElementById('total-box').style.display = total > 0 ? 'flex' : 'none';

  const nProdutos = new Set(itens.map(it => it.produto_nome)).size;
  document.getElementById('footer-count').textContent = nProdutos + ' produto' + (nProdutos !== 1 ? 's' : '') + ' (' + itens.length + ' op√ß√µes)';
  document.getElementById('btn-aceite').disabled = itens.length === 0 || approved;

  /* Totais por categoria (soma m√≠nima) */
  const byCat = {};
  itens.forEach(it => {
    if (!it.produto_nome) return;
    const cat = it.categoria || 'Insumo';
    const key = cat + '||' + it.produto_nome;
    if (!byCat[cat]) byCat[cat] = {};
    if (!byCat[cat][key] || Number(it.valor_ha || 0) < byCat[cat][key]) byCat[cat][key] = Number(it.valor_ha || 0);
  });
  const catTotais = {};
  Object.entries(byCat).forEach(([cat, prods]) => {
    catTotais[cat] = Object.values(prods).reduce((a, v) => a + v, 0);
  });

  const entries = Object.entries(catTotais).filter(([, v]) => v > 0).sort((a, b) => b[1] - a[1]);
  const colors  = entries.map(([c]) => getCatColor(c));
  const totalChart = entries.reduce((a, [, v]) => a + v, 0);

  if (!entries.length) {
    buildChart(['Sem itens'], [1], ['#1e1e1e']);
    buildLegend([], [], 0);
  } else {
    buildChart(entries.map(e => e[0]), entries.map(e => e[1]), colors);
    buildLegend(entries, colors, totalChart);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODAIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function abrirModal() {
  if (!allItens.length) return;
  const total = calcTotais(allItens);
  const el = document.getElementById('modal-summary');
  el.innerHTML = '';

  /* Mostra apenas 1 op√ß√£o (menor) por produto */
  const seen = {};
  const byCat = {};
  allItens.forEach(it => {
    if (!it.produto_nome) return;
    const cat = it.categoria || 'Insumo';
    const key = cat + '||' + it.produto_nome;
    if (!byCat[cat]) byCat[cat] = {};
    if (!byCat[cat][key] || Number(it.valor_ha || 0) < byCat[cat][key].valor_ha) {
      byCat[cat][key] = it;
    }
  });

  Object.entries(byCat).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([cat, prods]) => {
    Object.values(prods).forEach(it => {
      const chips = [
        it.principio_ativo ? `<span class="modal-chip"><b>P.A.</b>: ${esc(it.principio_ativo)}</span>` : '',
        it.fonte ? `<span class="modal-chip"><b>Fonte</b>: ${esc(it.fonte)}</span>` : '',
        (it.dose_ha != null && it.dose_ha !== '') ? `<span class="modal-chip"><b>Dose</b>: ${fmtBRL(Number(it.dose_ha))}${it.unidade ? ' ' + it.unidade : ''}</span>` : '',
        it.estagio ? `<span class="modal-chip"><b>Est√°dio</b>: ${esc(it.estagio)}</span>` : '',
        it.n_aplicacoes ? `<span class="modal-chip"><b>Aplic.</b>: ${it.n_aplicacoes}x</span>` : '',
        it.alvo ? `<span class="modal-chip"><b>Alvo</b>: ${esc(it.alvo)}</span>` : '',
        it.obs ? `<span class="modal-chip"><b>Obs</b>: ${esc(it.obs)}</span>` : '',
        (it.fornecedor && it.fornecedor !== 'N/I') ? `<span class="modal-chip"><b>Forn.</b>: ${esc(it.fornecedor)}</span>` : '',
      ].filter(Boolean).join('');

      const row = document.createElement('div');
      row.className = 'modal-item';
      row.innerHTML = `
        <div class="modal-item-top">
          <div class="modal-item-name">${esc(cat)} ‚Äî ${esc(it.produto_nome || 'Produto')}</div>
          <div class="modal-item-price">R$ ${fmtBRL(it.valor_ha || 0)}</div>
        </div>
        ${chips ? '<div class="modal-item-chips">' + chips + '</div>' : ''}
      `;
      el.appendChild(row);
    });
  });

  document.getElementById('modal-total-val').textContent = 'R$ ' + fmtBRL(total);
  document.getElementById('modal-backdrop').classList.add('open');
}
function fecharModal() { document.getElementById('modal-backdrop').classList.remove('open'); }
function fecharModalExterno(e) { if (e.target === document.getElementById('modal-backdrop')) fecharModal(); }
function abrirModalRecusa() { if (!approved) document.getElementById('modal-recusar-backdrop').classList.add('open'); }
function fecharModalRecusa() { document.getElementById('modal-recusar-backdrop').classList.remove('open'); }
function fecharModalRecusaExterno(e) { if (e.target === document.getElementById('modal-recusar-backdrop')) fecharModalRecusa(); }

async function confirmarAceite() {
  const btn = document.getElementById('btn-confirm-modal');
  btn.disabled = true; btn.textContent = 'Registrando...';
  try {
    await rpc('registrar_aceite_cotacao', { p_cotacao_id: cotacao.id, p_itens: [], p_total_ha: calcTotais(allItens), p_user_agent: navigator.userAgent });
    fecharModal();
    setAprovado(new Date().toISOString());
  } catch { alert('Erro ao registrar o aceite.'); }
  finally { btn.disabled = false; btn.textContent = 'Confirmar Aceite'; }
}

function setAprovado(ts) {
  approved = true;
  document.getElementById('status-pill').textContent = 'Aceite registrado';
  document.getElementById('status-pill').className = 'status-pill aprovado';
  const banner = document.getElementById('approved-banner');
  banner.classList.remove('recusado');
  document.getElementById('approved-title').textContent = 'Aceite Registrado';
  banner.style.display = 'block';
  document.getElementById('approved-ts').textContent = 'Registrado em ' + fmtDateTime(ts);
  document.getElementById('sticky-footer').style.display = 'none';
}

async function confirmarRecusa() {
  const btn = document.getElementById('btn-recusar-modal');
  btn.disabled = true; btn.textContent = 'Registrando...';
  try {
    await rpc('registrar_recusa_cotacao', { p_cotacao_id: cotacao.id, p_user_agent: navigator.userAgent });
    fecharModalRecusa();
    setRecusado(new Date().toISOString());
  } catch { alert('Erro ao recusar.'); }
  finally { btn.disabled = false; btn.textContent = 'Confirmar Recusa'; }
}

function setRecusado(ts) {
  approved = true;
  document.getElementById('status-pill').textContent = 'Recusada';
  document.getElementById('status-pill').className = 'status-pill recusado';
  const banner = document.getElementById('approved-banner');
  banner.classList.add('recusado');
  document.getElementById('approved-title').textContent = 'Cota√ß√£o Recusada';
  banner.style.display = 'block';
  document.getElementById('approved-ts').textContent = 'Registrado em ' + fmtDateTime(ts);
  document.getElementById('sticky-footer').style.display = 'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REST HELPER ‚Äî query direta nas tabelas do Supabase
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sbGet(table, params) {
  const qs = Object.entries(params)
    .map(([k, v]) => encodeURIComponent(k) + '=' + encodeURIComponent(v))
    .join('&');
  const r = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?' + qs, {
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: 'Bearer ' + SUPABASE_ANON,
      Accept: 'application/json',
    },
  });
  if (!r.ok) return [];
  return r.json();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function main() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('t') || params.get('token');
  if (!token) { showError('Token n√£o encontrado na URL.'); return; }

  try {
    /* ‚îÄ‚îÄ 1. Busca a cota√ß√£o pelo approval_token (campo do banco) ‚îÄ‚îÄ */
    const cotacoes = await sbGet('cotacoes', {
      select: 'id,titulo,status,created_at,consultor_id,fazenda_id,talhao_id,area_ha,aceite_em,approved_at,excel_itens_json',
      approval_token: 'eq.' + token,
      limit: 1,
    });

    /* Fallback: tenta o token como share_token tamb√©m */
    let cotRow = cotacoes[0];
    if (!cotRow) {
      const alt = await sbGet('cotacoes', {
        select: 'id,titulo,status,created_at,consultor_id,fazenda_id,talhao_id,area_ha,aceite_em,approved_at,excel_itens_json',
        share_token: 'eq.' + token,
        limit: 1,
      });
      cotRow = alt[0];
    }
    /* Fallback 2: tenta via RPC antigo */
    if (!cotRow) {
      try {
        const rpcRows = await rpc('get_cotacao_by_token', { p_token: token });
        cotRow = rpcRows && rpcRows[0];
      } catch (_) {}
    }

    if (!cotRow) { showError('Cota√ß√£o n√£o encontrada. Verifique o link.'); return; }
    cotacao = cotRow;

    console.log('[Agrocota] cota√ß√£o carregada:', cotacao.id, '| status:', cotacao.status);

    /* ‚îÄ‚îÄ 2. Consultor / Empresa ‚Äî direto na tabela profiles ‚îÄ‚îÄ */
    let consultorNome = '‚Äî', companyName = '', phone = '', logoUrl = '';
    if (cotacao.consultor_id) {
      try {
        const profiles = await sbGet('profiles', {
          select: 'full_name,company_name,phone,company_logo_url',
          id: 'eq.' + cotacao.consultor_id,
          limit: 1,
        });
        if (profiles[0]) {
          consultorNome = profiles[0].full_name         || '‚Äî';
          companyName   = profiles[0].company_name      || '';
          phone         = profiles[0].phone             || '';
          logoUrl       = profiles[0].company_logo_url  || '';
        }
      } catch (_) {}
    }

    /* ‚îÄ‚îÄ 3. Fazenda ‚Äî direto na tabela fazendas ‚îÄ‚îÄ */
    let fazendaNome = '‚Äî', produtorNome = '', municipio = '', estado = '';
    if (cotacao.fazenda_id) {
      try {
        const fazendas = await sbGet('fazendas', {
          select: 'nome,produtor_nome,municipio,estado',
          id: 'eq.' + cotacao.fazenda_id,
          limit: 1,
        });
        if (fazendas[0]) {
          fazendaNome  = fazendas[0].nome          || '‚Äî';
          produtorNome = fazendas[0].produtor_nome || '';
          municipio    = fazendas[0].municipio     || '';
          estado       = fazendas[0].estado        || '';
        }
      } catch (_) {}
    }
    const localizacao = [municipio, estado].filter(Boolean).join(' - ');

    /* ‚îÄ‚îÄ 4. Talh√£o ‚Äî para pegar area_ha quando n√£o estiver na cota√ß√£o ‚îÄ‚îÄ */
    let talhaoAreaHa = 0;
    if (cotacao.talhao_id) {
      try {
        const talhoes = await sbGet('talhoes', {
          select: 'area_ha',
          id: 'eq.' + cotacao.talhao_id,
          limit: 1,
        });
        if (talhoes[0]) talhaoAreaHa = Number(talhoes[0].area_ha || 0);
      } catch (_) {}
    }

    /* ‚îÄ‚îÄ 5. √Årea final (mesma l√≥gica do CotacaoGraficosScreen) ‚îÄ‚îÄ */
    const areaManual = Number(cotacao.area_ha || 0);
    const areaFinal  = areaManual > 0 ? areaManual : (talhaoAreaHa > 0 ? talhaoAreaHa : 0);
    areaFactor = areaFinal > 0 ? areaFinal : 1;

    /* ‚îÄ‚îÄ 6. Itens ‚Äî busca REST direta com TODOS os campos ‚îÄ‚îÄ */
    const COLS = [
      'id','produto_nome','fornecedor','categoria',
      'valor_ha','dose_ha','unidade',
      'principio_ativo','fonte',
      'estagio','n_aplicacoes','obs',
    ].join(',');

    const rawItens = await sbGet('itens_cotacao', {
      select: COLS,
      cotacao_id: 'eq.' + cotacao.id,
      order: 'categoria.asc,produto_nome.asc',
    });

    /* Tenta buscar colunas extras (podem n√£o existir no schema) */
    let extrasMap = {};
    try {
      const extras = await sbGet('itens_cotacao', {
        select: 'id,alvo,tecnologia,grupo_alvo,campo_adicional',
        cotacao_id: 'eq.' + cotacao.id,
      });
      extras.forEach(r => { extrasMap[r.id] = r; });
    } catch (_) {}

    /* Fallback PA/Fonte do excel_itens_json salvo na cota√ß√£o */
    const excelJson = Array.isArray(cotacao.excel_itens_json) ? cotacao.excel_itens_json : [];
    const excelByNome = {};
    excelJson.forEach(x => {
      const nome = (x.nome || x.produto || '').trim();
      if (nome) excelByNome[nome] = x;
    });

    allItens = (rawItens || []).map(it => {
      const ex  = excelByNome[String(it.produto_nome || '').trim()] || {};
      const ext = extrasMap[it.id] || {};
      return {
        ...it,
        principio_ativo:  it.principio_ativo || ex.ia || ex.principio_ativo || null,
        fonte:            it.fonte           || ex.fonte || null,
        alvo:             ext.alvo            || ex.alvo || null,
        tecnologia:       ext.tecnologia      || ex.tecnologia || null,
        grupo_alvo:       ext.grupo_alvo      || null,
        campo_adicional:  ext.campo_adicional || null,
        valor_ha:         Number(it.valor_ha  || 0) * areaFactor,
      };
    });

    console.log('[Agrocota]', allItens.length, 'itens carregados. Amostra:', {
      produto_nome:    allItens[0]?.produto_nome,
      principio_ativo: allItens[0]?.principio_ativo,
      fonte:           allItens[0]?.fonte,
      valor_ha:        allItens[0]?.valor_ha,
    });

    /* ‚îÄ‚îÄ 7. Inicializa cores alfab√©ticas (igual ao PDF) ‚îÄ‚îÄ */
    const cats = [...new Set(allItens.map(it => it.categoria || 'Insumo'))];
    initCatColors(cats);

    /* ‚îÄ‚îÄ 8. Logo ‚îÄ‚îÄ */
    if (logoUrl) {
      document.getElementById('logo-box').innerHTML = `<img src="${esc(logoUrl)}" alt="Logo" />`;
    }

    /* ‚îÄ‚îÄ 9. T√≠tulo ‚îÄ‚îÄ */
    document.title = cotacao.titulo || 'Cota√ß√£o Agrocota';
    document.getElementById('meta-titulo').textContent = cotacao.titulo || 'Cota√ß√£o';

    /* ‚îÄ‚îÄ 10. Grid de metadados ‚îÄ‚îÄ */
    addMeta('Fazenda', fazendaNome, true);
    if (produtorNome) addMeta('Produtor', produtorNome, true);
    if (areaFinal > 0) addMeta('√Årea', fmtBRL(areaFinal) + ' ha');
    addMeta('Data', fmtDate(cotacao.created_at));
    addMeta('Consultor', consultorNome);
    if (companyName) addMeta('Empresa', companyName);
    if (localizacao) addMeta('Localiza√ß√£o', localizacao, true);

    /* ‚îÄ‚îÄ 11. WhatsApp ‚îÄ‚îÄ */
    if (phone) {
      const wa = document.getElementById('whatsapp-btn');
      wa.href = 'https://wa.me/' + normBrPhone(phone);
      document.getElementById('whatsapp-phone').textContent = formatBrPhone(phone);
      wa.style.display = 'inline-flex';
    }

    /* ‚îÄ‚îÄ 12. Status (aceite/recusa j√° registrado) ‚îÄ‚îÄ */
    const aceiteEm = cotacao.aceite_em || cotacao.approved_at;
    if (cotacao.status === 'recusada') {
      setRecusado(aceiteEm || new Date().toISOString());
    } else if (cotacao.status === 'aprovada' || cotacao.status === 'aprovado' || aceiteEm) {
      setAprovado(aceiteEm || new Date().toISOString());
    }

    /* ‚îÄ‚îÄ 13. Renderiza conte√∫do ‚îÄ‚îÄ */
    renderProdutos(allItens);
    sync(allItens);

    /* ‚îÄ‚îÄ 14. Exibe app ‚îÄ‚îÄ */
    document.getElementById('state-loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';

  } catch (e) {
    console.error('[Agrocota] Erro fatal:', e);
    showError('Erro ao carregar os dados.');
  }
}

main();
</script>
</body>
</html>
